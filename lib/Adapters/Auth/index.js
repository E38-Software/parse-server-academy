"use strict";

var _AdapterLoader = _interopRequireDefault(require("../AdapterLoader"));
var _node = _interopRequireDefault(require("parse/node"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
const apple = require('./apple');
const gcenter = require('./gcenter');
const gpgames = require('./gpgames');
const facebook = require('./facebook');
const instagram = require('./instagram');
const linkedin = require('./linkedin');
const meetup = require('./meetup');
const google = require('./google');
const github = require('./github');
const twitter = require('./twitter');
const spotify = require('./spotify');
const digits = require('./twitter'); // digits tokens are validated by twitter
const janrainengage = require('./janrainengage');
const janraincapture = require('./janraincapture');
const line = require('./line');
const vkontakte = require('./vkontakte');
const qq = require('./qq');
const wechat = require('./wechat');
const weibo = require('./weibo');
const oauth2 = require('./oauth2');
const phantauth = require('./phantauth');
const microsoft = require('./microsoft');
const keycloak = require('./keycloak');
const ldap = require('./ldap');
const webauthn = require('./webauthn');
const anonymous = {
  validateAuthData: () => {
    return Promise.resolve();
  },
  validateAppId: () => {
    return Promise.resolve();
  }
};
const providers = {
  apple,
  gcenter,
  gpgames,
  facebook,
  instagram,
  linkedin,
  meetup,
  google,
  github,
  twitter,
  spotify,
  anonymous,
  digits,
  janrainengage,
  janraincapture,
  line,
  vkontakte,
  qq,
  wechat,
  weibo,
  phantauth,
  microsoft,
  keycloak,
  ldap,
  webauthn
};
function authDataValidator(provider, adapter, appIds, options) {
  return async function (authData, req, user, requestObject) {
    if (appIds && typeof adapter.validateAppId === 'function') {
      await Promise.resolve(adapter.validateAppId(appIds, authData, options, requestObject, req.config));
    }
    if (typeof adapter.validateAuthData === 'function') {
      return adapter.validateAuthData(authData, options, requestObject, req.config);
    } else if (typeof adapter.validateSetUp === 'function' && typeof adapter.validateLogin === 'function' && typeof adapter.validateUpdate === 'function') {
      // When masterKey is detected, we should trigger a logged in user
      const isLoggedIn = req.auth.user && user && req.auth.user.id === user.id || user && req.auth.isMaster;
      let hasAuthDataConfigured = false;
      if (user && user.get('authData') && user.get('authData')[provider]) {
        hasAuthDataConfigured = true;
      }
      if (isLoggedIn) {
        // User is updating their authData
        if (hasAuthDataConfigured) {
          return adapter.validateUpdate(authData, options, requestObject, req.config);
        }
        // Set up if the user does not have the provider configured
        return adapter.validateSetUp(authData, options, requestObject, req.config);
      }

      // Not logged in and authData is configured on the user
      if (hasAuthDataConfigured) {
        return adapter.validateLogin(authData, options, requestObject, req.config);
      }

      // User not logged in and the provider is not set up, for example when a new user
      // signs up or an existing user uses a new auth provider
      return adapter.validateSetUp(authData, options, requestObject, req.config);
    }
    throw new _node.default.Error(_node.default.Error.OTHER_CAUSE, 'Adapter is not configured. Implement either validateAuthData or all of the following: validateSetUp, validateLogin and validateUpdate');
  };
}
function loadAuthAdapter(provider, authOptions) {
  // providers are auth providers implemented by default
  let defaultAdapter = providers[provider];
  // authOptions can contain complete custom auth adapters or
  // a default auth adapter like Facebook
  const providerOptions = authOptions[provider];
  if (providerOptions && Object.prototype.hasOwnProperty.call(providerOptions, 'oauth2') && providerOptions['oauth2'] === true) {
    defaultAdapter = oauth2;
  }

  // Default provider not found and a custom auth provider was not provided
  if (!defaultAdapter && !providerOptions) {
    return;
  }
  const adapter = Object.assign({}, defaultAdapter);
  const appIds = providerOptions ? providerOptions.appIds : undefined;

  // Try the configuration methods
  if (providerOptions) {
    const optionalAdapter = (0, _AdapterLoader.default)(providerOptions, undefined, providerOptions);
    if (optionalAdapter) {
      ['validateAuthData', 'validateAppId', 'validateSetUp', 'validateLogin', 'validateUpdate', 'challenge', 'policy'].forEach(key => {
        if (optionalAdapter[key]) {
          adapter[key] = optionalAdapter[key];
        }
      });
    }
  }
  return {
    adapter,
    appIds,
    providerOptions
  };
}
module.exports = function (authOptions = {}, enableAnonymousUsers = true) {
  let _enableAnonymousUsers = enableAnonymousUsers;
  const setEnableAnonymousUsers = function (enable) {
    _enableAnonymousUsers = enable;
  };
  // To handle the test cases on configuration
  const getValidatorForProvider = function (provider) {
    if (provider === 'anonymous' && !_enableAnonymousUsers) {
      return {
        validator: undefined
      };
    }
    const authAdapter = loadAuthAdapter(provider, authOptions);
    if (!authAdapter) return;
    const {
      adapter,
      appIds,
      providerOptions
    } = authAdapter;
    return {
      validator: authDataValidator(provider, adapter, appIds, providerOptions),
      adapter
    };
  };
  return Object.freeze({
    getValidatorForProvider,
    setEnableAnonymousUsers
  });
};
module.exports.loadAuthAdapter = loadAuthAdapter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfQWRhcHRlckxvYWRlciIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwiX25vZGUiLCJvYmoiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsImFwcGxlIiwiZ2NlbnRlciIsImdwZ2FtZXMiLCJmYWNlYm9vayIsImluc3RhZ3JhbSIsImxpbmtlZGluIiwibWVldHVwIiwiZ29vZ2xlIiwiZ2l0aHViIiwidHdpdHRlciIsInNwb3RpZnkiLCJkaWdpdHMiLCJqYW5yYWluZW5nYWdlIiwiamFucmFpbmNhcHR1cmUiLCJsaW5lIiwidmtvbnRha3RlIiwicXEiLCJ3ZWNoYXQiLCJ3ZWlibyIsIm9hdXRoMiIsInBoYW50YXV0aCIsIm1pY3Jvc29mdCIsImtleWNsb2FrIiwibGRhcCIsIndlYmF1dGhuIiwiYW5vbnltb3VzIiwidmFsaWRhdGVBdXRoRGF0YSIsIlByb21pc2UiLCJyZXNvbHZlIiwidmFsaWRhdGVBcHBJZCIsInByb3ZpZGVycyIsImF1dGhEYXRhVmFsaWRhdG9yIiwicHJvdmlkZXIiLCJhZGFwdGVyIiwiYXBwSWRzIiwib3B0aW9ucyIsImF1dGhEYXRhIiwicmVxIiwidXNlciIsInJlcXVlc3RPYmplY3QiLCJjb25maWciLCJ2YWxpZGF0ZVNldFVwIiwidmFsaWRhdGVMb2dpbiIsInZhbGlkYXRlVXBkYXRlIiwiaXNMb2dnZWRJbiIsImF1dGgiLCJpZCIsImlzTWFzdGVyIiwiaGFzQXV0aERhdGFDb25maWd1cmVkIiwiZ2V0IiwiUGFyc2UiLCJFcnJvciIsIk9USEVSX0NBVVNFIiwibG9hZEF1dGhBZGFwdGVyIiwiYXV0aE9wdGlvbnMiLCJkZWZhdWx0QWRhcHRlciIsInByb3ZpZGVyT3B0aW9ucyIsIk9iamVjdCIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsImFzc2lnbiIsInVuZGVmaW5lZCIsIm9wdGlvbmFsQWRhcHRlciIsImxvYWRBZGFwdGVyIiwiZm9yRWFjaCIsImtleSIsIm1vZHVsZSIsImV4cG9ydHMiLCJlbmFibGVBbm9ueW1vdXNVc2VycyIsIl9lbmFibGVBbm9ueW1vdXNVc2VycyIsInNldEVuYWJsZUFub255bW91c1VzZXJzIiwiZW5hYmxlIiwiZ2V0VmFsaWRhdG9yRm9yUHJvdmlkZXIiLCJ2YWxpZGF0b3IiLCJhdXRoQWRhcHRlciIsImZyZWV6ZSJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9BZGFwdGVycy9BdXRoL2luZGV4LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2FkQWRhcHRlciBmcm9tICcuLi9BZGFwdGVyTG9hZGVyJztcbmltcG9ydCBQYXJzZSBmcm9tICdwYXJzZS9ub2RlJztcblxuY29uc3QgYXBwbGUgPSByZXF1aXJlKCcuL2FwcGxlJyk7XG5jb25zdCBnY2VudGVyID0gcmVxdWlyZSgnLi9nY2VudGVyJyk7XG5jb25zdCBncGdhbWVzID0gcmVxdWlyZSgnLi9ncGdhbWVzJyk7XG5jb25zdCBmYWNlYm9vayA9IHJlcXVpcmUoJy4vZmFjZWJvb2snKTtcbmNvbnN0IGluc3RhZ3JhbSA9IHJlcXVpcmUoJy4vaW5zdGFncmFtJyk7XG5jb25zdCBsaW5rZWRpbiA9IHJlcXVpcmUoJy4vbGlua2VkaW4nKTtcbmNvbnN0IG1lZXR1cCA9IHJlcXVpcmUoJy4vbWVldHVwJyk7XG5jb25zdCBnb29nbGUgPSByZXF1aXJlKCcuL2dvb2dsZScpO1xuY29uc3QgZ2l0aHViID0gcmVxdWlyZSgnLi9naXRodWInKTtcbmNvbnN0IHR3aXR0ZXIgPSByZXF1aXJlKCcuL3R3aXR0ZXInKTtcbmNvbnN0IHNwb3RpZnkgPSByZXF1aXJlKCcuL3Nwb3RpZnknKTtcbmNvbnN0IGRpZ2l0cyA9IHJlcXVpcmUoJy4vdHdpdHRlcicpOyAvLyBkaWdpdHMgdG9rZW5zIGFyZSB2YWxpZGF0ZWQgYnkgdHdpdHRlclxuY29uc3QgamFucmFpbmVuZ2FnZSA9IHJlcXVpcmUoJy4vamFucmFpbmVuZ2FnZScpO1xuY29uc3QgamFucmFpbmNhcHR1cmUgPSByZXF1aXJlKCcuL2phbnJhaW5jYXB0dXJlJyk7XG5jb25zdCBsaW5lID0gcmVxdWlyZSgnLi9saW5lJyk7XG5jb25zdCB2a29udGFrdGUgPSByZXF1aXJlKCcuL3Zrb250YWt0ZScpO1xuY29uc3QgcXEgPSByZXF1aXJlKCcuL3FxJyk7XG5jb25zdCB3ZWNoYXQgPSByZXF1aXJlKCcuL3dlY2hhdCcpO1xuY29uc3Qgd2VpYm8gPSByZXF1aXJlKCcuL3dlaWJvJyk7XG5jb25zdCBvYXV0aDIgPSByZXF1aXJlKCcuL29hdXRoMicpO1xuY29uc3QgcGhhbnRhdXRoID0gcmVxdWlyZSgnLi9waGFudGF1dGgnKTtcbmNvbnN0IG1pY3Jvc29mdCA9IHJlcXVpcmUoJy4vbWljcm9zb2Z0Jyk7XG5jb25zdCBrZXljbG9hayA9IHJlcXVpcmUoJy4va2V5Y2xvYWsnKTtcbmNvbnN0IGxkYXAgPSByZXF1aXJlKCcuL2xkYXAnKTtcbmNvbnN0IHdlYmF1dGhuID0gcmVxdWlyZSgnLi93ZWJhdXRobicpO1xuXG5jb25zdCBhbm9ueW1vdXMgPSB7XG4gIHZhbGlkYXRlQXV0aERhdGE6ICgpID0+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH0sXG4gIHZhbGlkYXRlQXBwSWQ6ICgpID0+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH0sXG59O1xuXG5jb25zdCBwcm92aWRlcnMgPSB7XG4gIGFwcGxlLFxuICBnY2VudGVyLFxuICBncGdhbWVzLFxuICBmYWNlYm9vayxcbiAgaW5zdGFncmFtLFxuICBsaW5rZWRpbixcbiAgbWVldHVwLFxuICBnb29nbGUsXG4gIGdpdGh1YixcbiAgdHdpdHRlcixcbiAgc3BvdGlmeSxcbiAgYW5vbnltb3VzLFxuICBkaWdpdHMsXG4gIGphbnJhaW5lbmdhZ2UsXG4gIGphbnJhaW5jYXB0dXJlLFxuICBsaW5lLFxuICB2a29udGFrdGUsXG4gIHFxLFxuICB3ZWNoYXQsXG4gIHdlaWJvLFxuICBwaGFudGF1dGgsXG4gIG1pY3Jvc29mdCxcbiAga2V5Y2xvYWssXG4gIGxkYXAsXG4gIHdlYmF1dGhuLFxufTtcblxuZnVuY3Rpb24gYXV0aERhdGFWYWxpZGF0b3IocHJvdmlkZXIsIGFkYXB0ZXIsIGFwcElkcywgb3B0aW9ucykge1xuICByZXR1cm4gYXN5bmMgZnVuY3Rpb24gKGF1dGhEYXRhLCByZXEsIHVzZXIsIHJlcXVlc3RPYmplY3QpIHtcbiAgICBpZiAoYXBwSWRzICYmIHR5cGVvZiBhZGFwdGVyLnZhbGlkYXRlQXBwSWQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGF3YWl0IFByb21pc2UucmVzb2x2ZShcbiAgICAgICAgYWRhcHRlci52YWxpZGF0ZUFwcElkKGFwcElkcywgYXV0aERhdGEsIG9wdGlvbnMsIHJlcXVlc3RPYmplY3QsIHJlcS5jb25maWcpXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIGFkYXB0ZXIudmFsaWRhdGVBdXRoRGF0YSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgcmV0dXJuIGFkYXB0ZXIudmFsaWRhdGVBdXRoRGF0YShhdXRoRGF0YSwgb3B0aW9ucywgcmVxdWVzdE9iamVjdCwgcmVxLmNvbmZpZyk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIHR5cGVvZiBhZGFwdGVyLnZhbGlkYXRlU2V0VXAgPT09ICdmdW5jdGlvbicgJiZcbiAgICAgIHR5cGVvZiBhZGFwdGVyLnZhbGlkYXRlTG9naW4gPT09ICdmdW5jdGlvbicgJiZcbiAgICAgIHR5cGVvZiBhZGFwdGVyLnZhbGlkYXRlVXBkYXRlID09PSAnZnVuY3Rpb24nXG4gICAgKSB7XG4gICAgICAvLyBXaGVuIG1hc3RlcktleSBpcyBkZXRlY3RlZCwgd2Ugc2hvdWxkIHRyaWdnZXIgYSBsb2dnZWQgaW4gdXNlclxuICAgICAgY29uc3QgaXNMb2dnZWRJbiA9XG4gICAgICAgIChyZXEuYXV0aC51c2VyICYmIHVzZXIgJiYgcmVxLmF1dGgudXNlci5pZCA9PT0gdXNlci5pZCkgfHwgKHVzZXIgJiYgcmVxLmF1dGguaXNNYXN0ZXIpO1xuICAgICAgbGV0IGhhc0F1dGhEYXRhQ29uZmlndXJlZCA9IGZhbHNlO1xuXG4gICAgICBpZiAodXNlciAmJiB1c2VyLmdldCgnYXV0aERhdGEnKSAmJiB1c2VyLmdldCgnYXV0aERhdGEnKVtwcm92aWRlcl0pIHtcbiAgICAgICAgaGFzQXV0aERhdGFDb25maWd1cmVkID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKGlzTG9nZ2VkSW4pIHtcbiAgICAgICAgLy8gVXNlciBpcyB1cGRhdGluZyB0aGVpciBhdXRoRGF0YVxuICAgICAgICBpZiAoaGFzQXV0aERhdGFDb25maWd1cmVkKSB7XG4gICAgICAgICAgcmV0dXJuIGFkYXB0ZXIudmFsaWRhdGVVcGRhdGUoYXV0aERhdGEsIG9wdGlvbnMsIHJlcXVlc3RPYmplY3QsIHJlcS5jb25maWcpO1xuICAgICAgICB9XG4gICAgICAgIC8vIFNldCB1cCBpZiB0aGUgdXNlciBkb2VzIG5vdCBoYXZlIHRoZSBwcm92aWRlciBjb25maWd1cmVkXG4gICAgICAgIHJldHVybiBhZGFwdGVyLnZhbGlkYXRlU2V0VXAoYXV0aERhdGEsIG9wdGlvbnMsIHJlcXVlc3RPYmplY3QsIHJlcS5jb25maWcpO1xuICAgICAgfVxuXG4gICAgICAvLyBOb3QgbG9nZ2VkIGluIGFuZCBhdXRoRGF0YSBpcyBjb25maWd1cmVkIG9uIHRoZSB1c2VyXG4gICAgICBpZiAoaGFzQXV0aERhdGFDb25maWd1cmVkKSB7XG4gICAgICAgIHJldHVybiBhZGFwdGVyLnZhbGlkYXRlTG9naW4oYXV0aERhdGEsIG9wdGlvbnMsIHJlcXVlc3RPYmplY3QsIHJlcS5jb25maWcpO1xuICAgICAgfVxuXG4gICAgICAvLyBVc2VyIG5vdCBsb2dnZWQgaW4gYW5kIHRoZSBwcm92aWRlciBpcyBub3Qgc2V0IHVwLCBmb3IgZXhhbXBsZSB3aGVuIGEgbmV3IHVzZXJcbiAgICAgIC8vIHNpZ25zIHVwIG9yIGFuIGV4aXN0aW5nIHVzZXIgdXNlcyBhIG5ldyBhdXRoIHByb3ZpZGVyXG4gICAgICByZXR1cm4gYWRhcHRlci52YWxpZGF0ZVNldFVwKGF1dGhEYXRhLCBvcHRpb25zLCByZXF1ZXN0T2JqZWN0LCByZXEuY29uZmlnKTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgUGFyc2UuRXJyb3IuT1RIRVJfQ0FVU0UsXG4gICAgICAnQWRhcHRlciBpcyBub3QgY29uZmlndXJlZC4gSW1wbGVtZW50IGVpdGhlciB2YWxpZGF0ZUF1dGhEYXRhIG9yIGFsbCBvZiB0aGUgZm9sbG93aW5nOiB2YWxpZGF0ZVNldFVwLCB2YWxpZGF0ZUxvZ2luIGFuZCB2YWxpZGF0ZVVwZGF0ZSdcbiAgICApO1xuICB9O1xufVxuXG5mdW5jdGlvbiBsb2FkQXV0aEFkYXB0ZXIocHJvdmlkZXIsIGF1dGhPcHRpb25zKSB7XG4gIC8vIHByb3ZpZGVycyBhcmUgYXV0aCBwcm92aWRlcnMgaW1wbGVtZW50ZWQgYnkgZGVmYXVsdFxuICBsZXQgZGVmYXVsdEFkYXB0ZXIgPSBwcm92aWRlcnNbcHJvdmlkZXJdO1xuICAvLyBhdXRoT3B0aW9ucyBjYW4gY29udGFpbiBjb21wbGV0ZSBjdXN0b20gYXV0aCBhZGFwdGVycyBvclxuICAvLyBhIGRlZmF1bHQgYXV0aCBhZGFwdGVyIGxpa2UgRmFjZWJvb2tcbiAgY29uc3QgcHJvdmlkZXJPcHRpb25zID0gYXV0aE9wdGlvbnNbcHJvdmlkZXJdO1xuICBpZiAoXG4gICAgcHJvdmlkZXJPcHRpb25zICYmXG4gICAgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb3ZpZGVyT3B0aW9ucywgJ29hdXRoMicpICYmXG4gICAgcHJvdmlkZXJPcHRpb25zWydvYXV0aDInXSA9PT0gdHJ1ZVxuICApIHtcbiAgICBkZWZhdWx0QWRhcHRlciA9IG9hdXRoMjtcbiAgfVxuXG4gIC8vIERlZmF1bHQgcHJvdmlkZXIgbm90IGZvdW5kIGFuZCBhIGN1c3RvbSBhdXRoIHByb3ZpZGVyIHdhcyBub3QgcHJvdmlkZWRcbiAgaWYgKCFkZWZhdWx0QWRhcHRlciAmJiAhcHJvdmlkZXJPcHRpb25zKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgYWRhcHRlciA9IE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRBZGFwdGVyKTtcbiAgY29uc3QgYXBwSWRzID0gcHJvdmlkZXJPcHRpb25zID8gcHJvdmlkZXJPcHRpb25zLmFwcElkcyA6IHVuZGVmaW5lZDtcblxuICAvLyBUcnkgdGhlIGNvbmZpZ3VyYXRpb24gbWV0aG9kc1xuICBpZiAocHJvdmlkZXJPcHRpb25zKSB7XG4gICAgY29uc3Qgb3B0aW9uYWxBZGFwdGVyID0gbG9hZEFkYXB0ZXIocHJvdmlkZXJPcHRpb25zLCB1bmRlZmluZWQsIHByb3ZpZGVyT3B0aW9ucyk7XG4gICAgaWYgKG9wdGlvbmFsQWRhcHRlcikge1xuICAgICAgW1xuICAgICAgICAndmFsaWRhdGVBdXRoRGF0YScsXG4gICAgICAgICd2YWxpZGF0ZUFwcElkJyxcbiAgICAgICAgJ3ZhbGlkYXRlU2V0VXAnLFxuICAgICAgICAndmFsaWRhdGVMb2dpbicsXG4gICAgICAgICd2YWxpZGF0ZVVwZGF0ZScsXG4gICAgICAgICdjaGFsbGVuZ2UnLFxuICAgICAgICAncG9saWN5JyxcbiAgICAgIF0uZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICBpZiAob3B0aW9uYWxBZGFwdGVyW2tleV0pIHtcbiAgICAgICAgICBhZGFwdGVyW2tleV0gPSBvcHRpb25hbEFkYXB0ZXJba2V5XTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHsgYWRhcHRlciwgYXBwSWRzLCBwcm92aWRlck9wdGlvbnMgfTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAoYXV0aE9wdGlvbnMgPSB7fSwgZW5hYmxlQW5vbnltb3VzVXNlcnMgPSB0cnVlKSB7XG4gIGxldCBfZW5hYmxlQW5vbnltb3VzVXNlcnMgPSBlbmFibGVBbm9ueW1vdXNVc2VycztcbiAgY29uc3Qgc2V0RW5hYmxlQW5vbnltb3VzVXNlcnMgPSBmdW5jdGlvbiAoZW5hYmxlKSB7XG4gICAgX2VuYWJsZUFub255bW91c1VzZXJzID0gZW5hYmxlO1xuICB9O1xuICAvLyBUbyBoYW5kbGUgdGhlIHRlc3QgY2FzZXMgb24gY29uZmlndXJhdGlvblxuICBjb25zdCBnZXRWYWxpZGF0b3JGb3JQcm92aWRlciA9IGZ1bmN0aW9uIChwcm92aWRlcikge1xuICAgIGlmIChwcm92aWRlciA9PT0gJ2Fub255bW91cycgJiYgIV9lbmFibGVBbm9ueW1vdXNVc2Vycykge1xuICAgICAgcmV0dXJuIHsgdmFsaWRhdG9yOiB1bmRlZmluZWQgfTtcbiAgICB9XG4gICAgY29uc3QgYXV0aEFkYXB0ZXIgPSBsb2FkQXV0aEFkYXB0ZXIocHJvdmlkZXIsIGF1dGhPcHRpb25zKTtcbiAgICBpZiAoIWF1dGhBZGFwdGVyKSByZXR1cm47XG4gICAgY29uc3QgeyBhZGFwdGVyLCBhcHBJZHMsIHByb3ZpZGVyT3B0aW9ucyB9ID0gYXV0aEFkYXB0ZXI7XG4gICAgcmV0dXJuIHsgdmFsaWRhdG9yOiBhdXRoRGF0YVZhbGlkYXRvcihwcm92aWRlciwgYWRhcHRlciwgYXBwSWRzLCBwcm92aWRlck9wdGlvbnMpLCBhZGFwdGVyIH07XG4gIH07XG5cbiAgcmV0dXJuIE9iamVjdC5mcmVlemUoe1xuICAgIGdldFZhbGlkYXRvckZvclByb3ZpZGVyLFxuICAgIHNldEVuYWJsZUFub255bW91c1VzZXJzLFxuICB9KTtcbn07XG5cbm1vZHVsZS5leHBvcnRzLmxvYWRBdXRoQWRhcHRlciA9IGxvYWRBdXRoQWRhcHRlcjtcbiJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFBQSxjQUFBLEdBQUFDLHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBQyxLQUFBLEdBQUFGLHNCQUFBLENBQUFDLE9BQUE7QUFBK0IsU0FBQUQsdUJBQUFHLEdBQUEsV0FBQUEsR0FBQSxJQUFBQSxHQUFBLENBQUFDLFVBQUEsR0FBQUQsR0FBQSxLQUFBRSxPQUFBLEVBQUFGLEdBQUE7QUFFL0IsTUFBTUcsS0FBSyxHQUFHTCxPQUFPLENBQUMsU0FBUyxDQUFDO0FBQ2hDLE1BQU1NLE9BQU8s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