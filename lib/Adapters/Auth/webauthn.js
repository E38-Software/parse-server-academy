"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.policy = exports.validateLogin = exports.validateUpdate = exports.validateSetUp = exports.challenge = exports.getOrigin = void 0;

var _server = require("@simplewebauthn/server");

var _node = _interopRequireDefault(require("parse/node"));

var _jsonwebtoken = require("jsonwebtoken");

var _crypto = _interopRequireDefault(require("crypto"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const toUserFriendlyRpName = url => {
  const domain = getDomainWithoutWww(url);
  const baseDomain = getBaseDomain(domain).split('.')[0];
  const words = baseDomain.split('-');
  return words.reduce((acc, word) => `${acc} ${word.charAt(0).toUpperCase() + word.slice(1)}`, '').trim();
};

const getJwtSecret = config => {
  const hash = _crypto.default.createHash('sha512');

  hash.update(config.masterKey, 'utf-8'); // Security:
  // sha512 return 128 chars, we can keep only 64 chars since it represent 6,61E98 combinations
  // using the hash allow to reduce risk of compromising the master key
  // if brute force is attempted on the JWT

  return hash.digest().toString('hex').slice(64);
}; // Example here: https://regex101.com/r/wN6cZ7/365


const getDomainWithoutWww = url => /^(?:https?:\/\/)?(?:[^@\/\n]+@)?(?:www\.)?([^:\/?\n]+)/g.exec(url)[1];

const getBaseDomain = domain => {
  const splittedDomain = domain.split('.'); // Handle localhost

  if (splittedDomain.length === 1) return domain.trim(); // Classic domains

  return `${splittedDomain[splittedDomain.length - 2]}.${splittedDomain[splittedDomain.length - 1]}`.trim();
};

const getOrigin = config => getBaseDomain(getDomainWithoutWww(config.publicServerURL || config.serverURL));

exports.getOrigin = getOrigin;

const extractSignedChallenge = (signedChallenge, config) => {
  if (!signedChallenge) throw new _node.default.Error(_node.default.Error.OTHER_CAUSE, 'signedChallenge is required.');
  let expectedChallenge;

  try {
    expectedChallenge = (0, _jsonwebtoken.verify)(signedChallenge, getJwtSecret(config)).challenge;
    if (!expectedChallenge) throw new Error();
    return expectedChallenge;
  } catch (e) {
    throw new _node.default.Error(_node.default.Error.OTHER_CAUSE, 'Invalid signedChallenge');
  }
}; // Return credentials options to the client
// for register public key process


const registerOptions = (user, options = {}, config) => {
  const registrationOptions = (0, _server.generateRegistrationOptions)({
    rpName: options && options.rpName || toUserFriendlyRpName(config.publicServerURL || config.serverURL),
    rpID: options.rpId || getOrigin(config),
    // here userId is only used as an identifier and this is never
    // retrieved by the user device
    // this has not real value for parse
    userID: user.id,
    // Could be an email or a firstname lastname depending of
    // the developer usage
    userDisplayName: typeof options.getUserDisplayName === 'function' ? options.getUserDisplayName(user) : user.get('email') || user.get('username'),
    userName: typeof options.getUsername === 'function' ? options.getUsername(user) : user.get('username'),
    timeout: 60000,
    attestationType: options.attestationType || 'indirect',
    authenticatorSelection: {
      // Use required to avoid silent sign up
      userVerification: options.userVerification || 'required',
      residentKey: options.residentKey || 'preferred'
    }
  });
  return {
    // Use jwt signed challenge to avoid storing challenge in DB
    // Master key is considered safe here to sign the challenge
    // Add additional 20sec for a bad network latency
    signedChallenge: (0, _jsonwebtoken.sign)({
      challenge: registrationOptions.challenge
    }, getJwtSecret(config), {
      expiresIn: registrationOptions.timeout + 20000
    }),
    options: registrationOptions
  };
}; // Verify the registration provided by the client


const verifyRegister = async ({
  signedChallenge,
  registration
}, options = {}, config) => {
  if (!registration) throw new _node.default.Error(_node.default.Error.OTHER_CAUSE, 'registration is required.');
  const expectedChallenge = extractSignedChallenge(signedChallenge, config);

  try {
    const {
      verified,
      registrationInfo
    } = await (0, _server.verifyRegistrationResponse)({
      credential: registration,
      expectedChallenge,
      expectedOrigin: options.origin || getOrigin(config),
      expectedRPID: options.rpId || getOrigin(config)
    });

    if (verified) {
      return {
        counter: registrationInfo.counter,
        publicKey: registrationInfo.credentialPublicKey.toString('base64'),
        id: registration.id
      };
    }
    /* istanbul ignore next: fail safe */


    throw new Error();
  } catch (e) {
    throw new _node.default.Error(_node.default.Error.OTHER_CAUSE, 'Invalid webauthn registration');
  }
};

const loginOptions = config => {
  const options = (0, _server.generateAuthenticationOptions)();
  return {
    options,
    signedChallenge: (0, _jsonwebtoken.sign)({
      challenge: options.challenge
    }, getJwtSecret(config), {
      expiresIn: options.timeout + 20000
    })
  };
};

const verifyLogin = ({
  authentication,
  signedChallenge
}, options = {}, config, user) => {
  const dbAuthData = user && user.get('authData') && user.get('authData').webauthn;
  if (!authentication) throw new _node.default.Error(_node.default.Error.OTHER_CAUSE, 'authentication is required.');
  const expectedChallenge = extractSignedChallenge(signedChallenge, config);

  try {
    const {
      verified,
      authenticationInfo
    } = (0, _server.verifyAuthenticationResponse)({
      credential: authentication,
      expectedChallenge,
      expectedOrigin: options.origin || getOrigin(config),
      expectedRPID: options.rpId || getOrigin(config),
      authenticator: {
        credentialID: Buffer.from(dbAuthData.id, 'base64'),
        counter: dbAuthData.counter,
        credentialPublicKey: Buffer.from(dbAuthData.publicKey, 'base64')
      }
    });

    if (verified) {
      return _objectSpread(_objectSpread({}, dbAuthData), {}, {
        counter: authenticationInfo.newCounter
      });
    }
    /* istanbul ignore next: fail safe */


    throw new Error();
  } catch (e) {
    throw new _node.default.Error(_node.default.Error.OTHER_CAUSE, 'Invalid webauthn authentication');
  }
};

const challenge = async (challengeData, authData, adapterConfig = {}, request, config) => {
  // Allow logged user to update/setUp webauthn
  if (request.user && request.user.id) {
    return registerOptions(request.user, adapterConfig.options, config);
  }

  return loginOptions(config);
};

exports.challenge = challenge;

const validateSetUp = async (authData, adapterConfig = {}, request, config) => {
  if (!request.user && !request.master) throw new _node.default.Error(_node.default.Error.OTHER_CAUSE, 'Webauthn can only be configured on an already logged in user.');
  return {
    save: await verifyRegister(authData, adapterConfig.options, config)
  };
};

exports.validateSetUp = validateSetUp;
const validateUpdate = validateSetUp;
exports.validateUpdate = validateUpdate;

const validateLogin = async (authData, adapterConfig = {}, request, config) => {
  if (!request.original) throw new _node.default.Error(_node.default.Error.OTHER_CAUSE, 'User not found for webauthn login.'); // Will save updated counter of the credential
  // and avoid cloned/bugged authenticators

  return {
    save: verifyLogin(authData, adapterConfig.options, config, request.original)
  };
};

exports.validateLogin = validateLogin;
const policy = 'solo';
exports.policy = policy;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9BZGFwdGVycy9BdXRoL3dlYmF1dGhuLmpzIl0sIm5hbWVzIjpbInRvVXNlckZyaWVuZGx5UnBOYW1lIiwidXJsIiwiZG9tYWluIiwiZ2V0RG9tYWluV2l0aG91dFd3dyIsImJhc2VEb21haW4iLCJnZXRCYXNlRG9tYWluIiwic3BsaXQiLCJ3b3JkcyIsInJlZHVjZSIsImFjYyIsIndvcmQiLCJjaGFyQXQiLCJ0b1VwcGVyQ2FzZSIsInNsaWNlIiwidHJpbSIsImdldEp3dFNlY3JldCIsImNvbmZpZyIsImhhc2giLCJjcnlwdG8iLCJjcmVhdGVIYXNoIiwidXBkYXRlIiwibWFzdGVyS2V5IiwiZGlnZXN0IiwidG9TdHJpbmciLCJleGVjIiwic3BsaXR0ZWREb21haW4iLCJsZW5ndGgiLCJnZXRPcmlnaW4iLCJwdWJsaWNTZXJ2ZXJVUkwiLCJzZXJ2ZXJVUkwiLCJleHRyYWN0U2lnbmVkQ2hhbGxlbmdlIiwic2lnbmVkQ2hhbGxlbmdlIiwiUGFyc2UiLCJFcnJvciIsIk9USEVSX0NBVVNFIiwiZXhwZWN0ZWRDaGFsbGVuZ2UiLCJjaGFsbGVuZ2UiLCJlIiwicmVnaXN0ZXJPcHRpb25zIiwidXNlciIsIm9wdGlvbnMiLCJyZWdpc3RyYXRpb25PcHRpb25zIiwicnBOYW1lIiwicnBJRCIsInJwSWQiLCJ1c2VySUQiLCJpZCIsInVzZXJEaXNwbGF5TmFtZSIsImdldFVzZXJEaXNwbGF5TmFtZSIsImdldCIsInVzZXJOYW1lIiwiZ2V0VXNlcm5hbWUiLCJ0aW1lb3V0IiwiYXR0ZXN0YXRpb25UeXBlIiwiYXV0aGVudGljYXRvclNlbGVjdGlvbiIsInVzZXJWZXJpZmljYXRpb24iLCJyZXNpZGVudEtleSIsImV4cGlyZXNJbiIsInZlcmlmeVJlZ2lzdGVyIiwicmVnaXN0cmF0aW9uIiwidmVyaWZpZWQiLCJyZWdpc3RyYXRpb25JbmZvIiwiY3JlZGVudGlhbCIsImV4cGVjdGVkT3JpZ2luIiwib3JpZ2luIiwiZXhwZWN0ZWRSUElEIiwiY291bnRlciIsInB1YmxpY0tleSIsImNyZWRlbnRpYWxQdWJsaWNLZXkiLCJsb2dpbk9wdGlvbnMiLCJ2ZXJpZnlMb2dpbiIsImF1dGhlbnRpY2F0aW9uIiwiZGJBdXRoRGF0YSIsIndlYmF1dGhuIiwiYXV0aGVudGljYXRpb25JbmZvIiwiYXV0aGVudGljYXRvciIsImNyZWRlbnRpYWxJRCIsIkJ1ZmZlciIsImZyb20iLCJuZXdDb3VudGVyIiwiY2hhbGxlbmdlRGF0YSIsImF1dGhEYXRhIiwiYWRhcHRlckNvbmZpZyIsInJlcXVlc3QiLCJ2YWxpZGF0ZVNldFVwIiwibWFzdGVyIiwic2F2ZSIsInZhbGlkYXRlVXBkYXRlIiwidmFsaWRhdGVMb2dpbiIsIm9yaWdpbmFsIiwicG9saWN5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBS0E7O0FBTUE7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7QUFFQSxNQUFNQSxvQkFBb0IsR0FBR0MsR0FBRyxJQUFJO0FBQ2hDLFFBQU1DLE1BQU0sR0FBR0MsbUJBQW1CLENBQUNGLEdBQUQsQ0FBbEM7QUFDQSxRQUFNRyxVQUFVLEdBQUdDLGFBQWEsQ0FBQ0gsTUFBRCxDQUFiLENBQXNCSSxLQUF0QixDQUE0QixHQUE1QixFQUFpQyxDQUFqQyxDQUFuQjtBQUNBLFFBQU1DLEtBQUssR0FBR0gsVUFBVSxDQUFDRSxLQUFYLENBQWlCLEdBQWpCLENBQWQ7QUFDQSxTQUFPQyxLQUFLLENBQ1BDLE1BREUsQ0FDSyxDQUFDQyxHQUFELEVBQU1DLElBQU4sS0FBZ0IsR0FBRUQsR0FBSSxJQUFHQyxJQUFJLENBQUNDLE1BQUwsQ0FBWSxDQUFaLEVBQWVDLFdBQWYsS0FBK0JGLElBQUksQ0FBQ0csS0FBTCxDQUFXLENBQVgsQ0FBYyxFQUQzRSxFQUM4RSxFQUQ5RSxFQUVGQyxJQUZFLEVBQVA7QUFHSCxDQVBEOztBQVNBLE1BQU1DLFlBQVksR0FBR0MsTUFBTSxJQUFJO0FBQzNCLFFBQU1DLElBQUksR0FBR0MsZ0JBQU9DLFVBQVAsQ0FBa0IsUUFBbEIsQ0FBYjs7QUFDQUYsRUFBQUEsSUFB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T0FBT1AsUUFBUCxFQUFpQkMsYUFBYSxHQUFHLEVBQWpDLEVBQXFDQyxPQUFyQyxFQUE4Q25FLE1BQTlDLEtBQXlEO0FBQ2xGLE1BQUksQ0FBQ21FLE9BQU8sQ0FBQ00sUUFBYixFQUNJLE1BQU0sSUFBSXpELGNBQU1DLEtBQVYsQ0FBZ0JELGNBQU1DLEtBQU4sQ0FBWUMsV0FBNUIsRUFBeUMsb0NBQXpDLENBQU4sQ0FGOEUsQ0FHbEY7QUFDQTs7QUFDQSxTQUFPO0FBQUVvRCxJQUFBQSxJQUFJLEVBQUVoQixXQUFXLENBQUNXLFFBQUQsRUFBV0MsYUFBYSxDQUFDMUMsT0FBekIsRUFBa0N4QixNQUFsQyxFQUEwQ21FLE9BQU8sQ0FBQ00sUUFBbEQ7QUFBbkIsR0FBUDtBQUNILENBTk07OztBQVFBLE1BQU1DLE1BQU0sR0FBRyxNQUFmIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBXZWJBdXRobiBBZGFwdGVyIGNhbiBiZSB1c2VkIGFzIGFuIGFsdGVybmF0aXZlIHdheSB0byBsb2dpblxuICogU2luY2Ugd2UgY2Fubm90IHN1cHBvcnQgY3VycmVudGx5IHNpZ251cCB3aXRoIHdlYmF1dGhuIHdpbGwgdGhyb3cgYW4gZXJyb3IgKGR1ZSB0byBsYWNrIG9mIHJlc2V0IHByb2Nlc3MpXG4gKiBVc2VyIG5lZWQgdG8gYmUgbG9nZ2VkIGluIHRvIHNldHVwIHRoZSB3ZWJhdXRobiBwcm92aWRlclxuICovXG5pbXBvcnQge1xuICAgIGdlbmVyYXRlUmVnaXN0cmF0aW9uT3B0aW9ucyxcbiAgICB2ZXJpZnlSZWdpc3RyYXRpb25SZXNwb25zZSxcbiAgICBnZW5lcmF0ZUF1dGhlbnRpY2F0aW9uT3B0aW9ucyxcbiAgICB2ZXJpZnlBdXRoZW50aWNhdGlvblJlc3BvbnNlLFxufSBmcm9tICdAc2ltcGxld2ViYXV0aG4vc2VydmVyJztcbmltcG9ydCBQYXJzZSBmcm9tICdwYXJzZS9ub2RlJztcbmltcG9ydCB7IHNpZ24sIHZlcmlmeSB9IGZyb20gJ2pzb253ZWJ0b2tlbic7XG5pbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5cbmNvbnN0IHRvVXNlckZyaWVuZGx5UnBOYW1lID0gdXJsID0+IHtcbiAgICBjb25zdCBkb21haW4gPSBnZXREb21haW5XaXRob3V0V3d3KHVybCk7XG4gICAgY29uc3QgYmFzZURvbWFpbiA9IGdldEJhc2VEb21haW4oZG9tYWluKS5zcGxpdCgnLicpWzBdO1xuICAgIGNvbnN0IHdvcmRzID0gYmFzZURvbWFpbi5zcGxpdCgnLScpO1xuICAgIHJldHVybiB3b3Jkc1xuICAgICAgICAucmVkdWNlKChhY2MsIHdvcmQpID0+IGAke2FjY30gJHt3b3JkLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgd29yZC5zbGljZSgxKX1gLCAnJylcbiAgICAgICAgLnRyaW0oKTtcbn07XG5cbmNvbnN0IGdldEp3dFNlY3JldCA9IGNvbmZpZyA9PiB7XG4gICAgY29uc3QgaGFzaCA9IGNyeXB0by5jcmVhdGVIYXNoKCdzaGE1MTInKTtcbiAgICBoYXNoLnVwZGF0ZShjb25maWcubWFzdGVyS2V5LCAndXRmLTgnKTtcbiAgICAvLyBTZWN1cml0eTpcbiAgICAvLyBzaGE1MTIgcmV0dXJuIDEyOCBjaGFycywgd2UgY2FuIGtlZXAgb25seSA2NCBjaGFycyBzaW5jZSBpdCByZXByZXNlbnQgNiw2MUU5OCBjb21iaW5hdGlvbnNcbiAgICAvLyB1c2luZyB0aGUgaGFzaCBhbGxvdyB0byByZWR1Y2UgcmlzayBvZiBjb21wcm9taXNpbmcgdGhlIG1hc3RlciBrZXlcbiAgICAvLyBpZiBicnV0ZSBmb3JjZSBpcyBhdHRlbXB0ZWQgb24gdGhlIEpXVFxuICAgIHJldHVybiBoYXNoLmRpZ2VzdCgpLnRvU3RyaW5nKCdoZXgnKS5zbGljZSg2NCk7XG59O1xuXG4vLyBFeGFtcGxlIGhlcmU6IGh0dHBzOi8vcmVnZXgxMDEuY29tL3Ivd042Y1o3LzM2NVxuY29uc3QgZ2V0RG9tYWluV2l0aG91dFd3dyA9IHVybCA9PlxuICAgIC9eKD86aHR0cHM/OlxcL1xcLyk/KD86W15AXFwvXFxuXStAKT8oPzp3d3dcXC4pPyhbXjpcXC8/XFxuXSspL2cuZXhlYyh1cmwpWzFdO1xuXG5jb25zdCBnZXRCYXNlRG9tYWluID0gZG9tYWluID0+IHtcbiAgICBjb25zdCBzcGxpdHRlZERvbWFpbiA9IGRvbWFpbi5zcGxpdCgnLicpO1xuICAgIC8vIEhhbmRsZSBsb2NhbGhvc3RcbiAgICBpZiAoc3BsaXR0ZWREb21haW4ubGVuZ3RoID09PSAxKSByZXR1cm4gZG9tYWluLnRyaW0oKTtcbiAgICAvLyBDbGFzc2ljIGRvbWFpbnNcbiAgICByZXR1cm4gYCR7c3BsaXR0ZWREb21haW5bc3BsaXR0ZWREb21haW4ubGVuZ3RoIC0gMl19LiR7c3BsaXR0ZWREb21haW5bc3BsaXR0ZWREb21haW4ubGVuZ3RoIC0gMV1cbiAgICAgICAgfWAudHJpbSgpO1xufTtcblxuZXhwb3J0IGNvbnN0IGdldE9yaWdpbiA9IGNvbmZpZyA9PlxuICAgIGdldEJhc2VEb21haW4oZ2V0RG9tYWluV2l0aG91dFd3dyhjb25maWcucHVibGljU2VydmVyVVJMIHx8IGNvbmZpZy5zZXJ2ZXJVUkwpKTtcblxuY29uc3QgZXh0cmFjdFNpZ25lZENoYWxsZW5nZSA9IChzaWduZWRDaGFsbGVuZ2UsIGNvbmZpZykgPT4ge1xuICAgIGlmICghc2lnbmVkQ2hhbGxlbmdlKVxuICAgICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuT1RIRVJfQ0FVU0UsICdzaWduZWRDaGFsbGVuZ2UgaXMgcmVxdWlyZWQuJyk7XG4gICAgbGV0IGV4cGVjdGVkQ2hhbGxlbmdlO1xuICAgIHRyeSB7XG4gICAgICAgIGV4cGVjdGVkQ2hhbGxlbmdlID0gdmVyaWZ5KHNpZ25lZENoYWxsZW5nZSwgZ2V0Snd0U2VjcmV0KGNvbmZpZykpLmNoYWxsZW5nZTtcbiAgICAgICAgaWYgKCFleHBlY3RlZENoYWxsZW5nZSkgdGhyb3cgbmV3IEVycm9yKCk7XG4gICAgICAgIHJldHVybiBleHBlY3RlZENoYWxsZW5nZTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5PVEhFUl9DQVVTRSwgJ0ludmFsaWQgc2lnbmVkQ2hhbGxlbmdlJyk7XG4gICAgfVxufTtcblxuLy8gUmV0dXJuIGNyZWRlbnRpYWxzIG9wdGlvbnMgdG8gdGhlIGNsaWVudFxuLy8gZm9yIHJlZ2lzdGVyIHB1YmxpYyBrZXkgcHJvY2Vzc1xuY29uc3QgcmVnaXN0ZXJPcHRpb25zID0gKHVzZXIsIG9wdGlvbnMgPSB7fSwgY29uZmlnKSA9PiB7XG4gICAgY29uc3QgcmVnaXN0cmF0aW9uT3B0aW9ucyA9IGdlbmVyYXRlUmVnaXN0cmF0aW9uT3B0aW9ucyh7XG4gICAgICAgIHJwTmFtZTpcbiAgICAgICAgICAgIChvcHRpb25zICYmIG9wdGlvbnMucnBOYW1lKSB8fFxuICAgICAgICAgICAgdG9Vc2VyRnJpZW5kbHlScE5hbWUoY29uZmlnLnB1YmxpY1NlcnZlclVSTCB8fCBjb25maWcuc2VydmVyVVJMKSxcbiAgICAgICAgcnBJRDogb3B0aW9ucy5ycElkIHx8IGdldE9yaWdpbihjb25maWcpLFxuICAgICAgICAvLyBoZXJlIHVzZXJJZCBpcyBvbmx5IHVzZWQgYXMgYW4gaWRlbnRpZmllciBhbmQgdGhpcyBpcyBuZXZlclxuICAgICAgICAvLyByZXRyaWV2ZWQgYnkgdGhlIHVzZXIgZGV2aWNlXG4gICAgICAgIC8vIHRoaXMgaGFzIG5vdCByZWFsIHZhbHVlIGZvciBwYXJzZVxuICAgICAgICB1c2VySUQ6IHVzZXIuaWQsXG4gICAgICAgIC8vIENvdWxkIGJlIGFuIGVtYWlsIG9yIGEgZmlyc3RuYW1lIGxhc3RuYW1lIGRlcGVuZGluZyBvZlxuICAgICAgICAvLyB0aGUgZGV2ZWxvcGVyIHVzYWdlXG4gICAgICAgIHVzZXJEaXNwbGF5TmFtZTpcbiAgICAgICAgICAgIHR5cGVvZiBvcHRpb25zLmdldFVzZXJEaXNwbGF5TmFtZSA9PT0gJ2Z1bmN0aW9uJ1xuICAgICAgICAgICAgICAgID8gb3B0aW9ucy5nZXRVc2VyRGlzcGxheU5hbWUodXNlcilcbiAgICAgICAgICAgICAgICA6IHVzZXIuZ2V0KCdlbWFpbCcpIHx8IHVzZXIuZ2V0KCd1c2VybmFtZScpLFxuICAgICAgICB1c2VyTmFtZTpcbiAgICAgICAgICAgIHR5cGVvZiBvcHRpb25zLmdldFVzZXJuYW1lID09PSAnZnVuY3Rpb24nID8gb3B0aW9ucy5nZXRVc2VybmFtZSh1c2VyKSA6IHVzZXIuZ2V0KCd1c2VybmFtZScpLFxuICAgICAgICB0aW1lb3V0OiA2MDAwMCxcbiAgICAgICAgYXR0ZXN0YXRpb25UeXBlOiBvcHRpb25zLmF0dGVzdGF0aW9uVHlwZSB8fCAnaW5kaXJlY3QnLFxuICAgICAgICBhdXRoZW50aWNhdG9yU2VsZWN0aW9uOiB7XG4gICAgICAgICAgICAvLyBVc2UgcmVxdWlyZWQgdG8gYXZvaWQgc2lsZW50IHNpZ24gdXBcbiAgICAgICAgICAgIHVzZXJWZXJpZmljYXRpb246IG9wdGlvbnMudXNlclZlcmlmaWNhdGlvbiB8fCAncmVxdWlyZWQnLFxuICAgICAgICAgICAgcmVzaWRlbnRLZXk6IG9wdGlvbnMucmVzaWRlbnRLZXkgfHwgJ3ByZWZlcnJlZCcsXG4gICAgICAgIH0sXG4gICAgfSk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgLy8gVXNlIGp3dCBzaWduZWQgY2hhbGxlbmdlIHRvIGF2b2lkIHN0b3JpbmcgY2hhbGxlbmdlIGluIERCXG4gICAgICAgIC8vIE1hc3RlciBrZXkgaXMgY29uc2lkZXJlZCBzYWZlIGhlcmUgdG8gc2lnbiB0aGUgY2hhbGxlbmdlXG4gICAgICAgIC8vIEFkZCBhZGRpdGlvbmFsIDIwc2VjIGZvciBhIGJhZCBuZXR3b3JrIGxhdGVuY3lcbiAgICAgICAgc2lnbmVkQ2hhbGxlbmdlOiBzaWduKHsgY2hhbGxlbmdlOiByZWdpc3RyYXRpb25PcHRpb25zLmNoYWxsZW5nZSB9LCBnZXRKd3RTZWNyZXQoY29uZmlnKSwge1xuICAgICAgICAgICAgZXhwaXJlc0luOiByZWdpc3RyYXRpb25PcHRpb25zLnRpbWVvdXQgKyAyMDAwMCxcbiAgICAgICAgfSksXG4gICAgICAgIG9wdGlvbnM6IHJlZ2lzdHJhdGlvbk9wdGlvbnMsXG4gICAgfTtcbn07XG5cbi8vIFZlcmlmeSB0aGUgcmVnaXN0cmF0aW9uIHByb3ZpZGVkIGJ5IHRoZSBjbGllbnRcbmNvbnN0IHZlcmlmeVJlZ2lzdGVyID0gYXN5bmMgKHsgc2lnbmVkQ2hhbGxlbmdlLCByZWdpc3RyYXRpb24gfSwgb3B0aW9ucyA9IHt9LCBjb25maWcpID0+IHtcbiAgICBpZiAoIXJlZ2lzdHJhdGlvbikgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLk9USEVSX0NBVVNFLCAncmVnaXN0cmF0aW9uIGlzIHJlcXVpcmVkLicpO1xuICAgIGNvbnN0IGV4cGVjdGVkQ2hhbGxlbmdlID0gZXh0cmFjdFNpZ25lZENoYWxsZW5nZShzaWduZWRDaGFsbGVuZ2UsIGNvbmZpZyk7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgeyB2ZXJpZmllZCwgcmVnaXN0cmF0aW9uSW5mbyB9ID0gYXdhaXQgdmVyaWZ5UmVnaXN0cmF0aW9uUmVzcG9uc2Uoe1xuICAgICAgICAgICAgY3JlZGVudGlhbDogcmVnaXN0cmF0aW9uLFxuICAgICAgICAgICAgZXhwZWN0ZWRDaGFsbGVuZ2UsXG4gICAgICAgICAgICBleHBlY3RlZE9yaWdpbjogb3B0aW9ucy5vcmlnaW4gfHwgZ2V0T3JpZ2luKGNvbmZpZyksXG4gICAgICAgICAgICBleHBlY3RlZFJQSUQ6IG9wdGlvbnMucnBJZCB8fCBnZXRPcmlnaW4oY29uZmlnKSxcbiAgICAgICAgfSk7XG4gICAgICAgIGlmICh2ZXJpZmllZCkge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBjb3VudGVyOiByZWdpc3RyYXRpb25JbmZvLmNvdW50ZXIsXG4gICAgICAgICAgICAgICAgcHVibGljS2V5OiByZWdpc3RyYXRpb25JbmZvLmNyZWRlbnRpYWxQdWJsaWNLZXkudG9TdHJpbmcoJ2Jhc2U2NCcpLFxuICAgICAgICAgICAgICAgIGlkOiByZWdpc3RyYXRpb24uaWQsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0OiBmYWlsIHNhZmUgKi9cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuT1RIRVJfQ0FVU0UsICdJbnZhbGlkIHdlYmF1dGhuIHJlZ2lzdHJhdGlvbicpO1xuICAgIH1cbn07XG5cbmNvbnN0IGxvZ2luT3B0aW9ucyA9IGNvbmZpZyA9PiB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IGdlbmVyYXRlQXV0aGVudGljYXRpb25PcHRpb25zKCk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgc2lnbmVkQ2hhbGxlbmdlOiBzaWduKHsgY2hhbGxlbmdlOiBvcHRpb25zLmNoYWxsZW5nZSB9LCBnZXRKd3RTZWNyZXQoY29uZmlnKSwge1xuICAgICAgICAgICAgZXhwaXJlc0luOiBvcHRpb25zLnRpbWVvdXQgKyAyMDAwMCxcbiAgICAgICAgfSksXG4gICAgfTtcbn07XG5cbmNvbnN0IHZlcmlmeUxvZ2luID0gKHsgYXV0aGVudGljYXRpb24sIHNpZ25lZENoYWxsZW5nZSB9LCBvcHRpb25zID0ge30sIGNvbmZpZywgdXNlcikgPT4ge1xuICAgIGNvbnN0IGRiQXV0aERhdGEgPSB1c2VyICYmIHVzZXIuZ2V0KCdhdXRoRGF0YScpICYmIHVzZXIuZ2V0KCdhdXRoRGF0YScpLndlYmF1dGhuO1xuICAgIGlmICghYXV0aGVudGljYXRpb24pXG4gICAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5PVEhFUl9DQVVTRSwgJ2F1dGhlbnRpY2F0aW9uIGlzIHJlcXVpcmVkLicpO1xuICAgIGNvbnN0IGV4cGVjdGVkQ2hhbGxlbmdlID0gZXh0cmFjdFNpZ25lZENoYWxsZW5nZShzaWduZWRDaGFsbGVuZ2UsIGNvbmZpZyk7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgeyB2ZXJpZmllZCwgYXV0aGVudGljYXRpb25JbmZvIH0gPSB2ZXJpZnlBdXRoZW50aWNhdGlvblJlc3BvbnNlKHtcbiAgICAgICAgICAgIGNyZWRlbnRpYWw6IGF1dGhlbnRpY2F0aW9uLFxuICAgICAgICAgICAgZXhwZWN0ZWRDaGFsbGVuZ2UsXG4gICAgICAgICAgICBleHBlY3RlZE9yaWdpbjogb3B0aW9ucy5vcmlnaW4gfHwgZ2V0T3JpZ2luKGNvbmZpZyksXG4gICAgICAgICAgICBleHBlY3RlZFJQSUQ6IG9wdGlvbnMucnBJZCB8fCBnZXRPcmlnaW4oY29uZmlnKSxcbiAgICAgICAgICAgIGF1dGhlbnRpY2F0b3I6IHtcbiAgICAgICAgICAgICAgICBjcmVkZW50aWFsSUQ6IEJ1ZmZlci5mcm9tKGRiQXV0aERhdGEuaWQsICdiYXNlNjQnKSxcbiAgICAgICAgICAgICAgICBjb3VudGVyOiBkYkF1dGhEYXRhLmNvdW50ZXIsXG4gICAgICAgICAgICAgICAgY3JlZGVudGlhbFB1YmxpY0tleTogQnVmZmVyLmZyb20oZGJBdXRoRGF0YS5wdWJsaWNLZXksICdiYXNlNjQnKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgICBpZiAodmVyaWZpZWQpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgLi4uZGJBdXRoRGF0YSxcbiAgICAgICAgICAgICAgICBjb3VudGVyOiBhdXRoZW50aWNhdGlvbkluZm8ubmV3Q291bnRlcixcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQ6IGZhaWwgc2FmZSAqL1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5PVEhFUl9DQVVTRSwgJ0ludmFsaWQgd2ViYXV0aG4gYXV0aGVudGljYXRpb24nKTtcbiAgICB9XG59O1xuXG5leHBvcnQgY29uc3QgY2hhbGxlbmdlID0gYXN5bmMgKGNoYWxsZW5nZURhdGEsIGF1dGhEYXRhLCBhZGFwdGVyQ29uZmlnID0ge30sIHJlcXVlc3QsIGNvbmZpZykgPT4ge1xuICAgIC8vIEFsbG93IGxvZ2dlZCB1c2VyIHRvIHVwZGF0ZS9zZXRVcCB3ZWJhdXRoblxuICAgIGlmIChyZXF1ZXN0LnVzZXIgJiYgcmVxdWVzdC51c2VyLmlkKSB7XG4gICAgICAgIHJldHVybiByZWdpc3Rlck9wdGlvbnMocmVxdWVzdC51c2VyLCBhZGFwdGVyQ29uZmlnLm9wdGlvbnMsIGNvbmZpZyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGxvZ2luT3B0aW9ucyhjb25maWcpO1xufTtcblxuZXhwb3J0IGNvbnN0IHZhbGlkYXRlU2V0VXAgPSBhc3luYyAoYXV0aERhdGEsIGFkYXB0ZXJDb25maWcgPSB7fSwgcmVxdWVzdCwgY29uZmlnKSA9PiB7XG4gICAgaWYgKCFyZXF1ZXN0LnVzZXIgJiYgIXJlcXVlc3QubWFzdGVyKVxuICAgICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgICAgICBQYXJzZS5FcnJvci5PVEhFUl9DQVVTRSxcbiAgICAgICAgICAgICdXZWJhdXRobiBjYW4gb25seSBiZSBjb25maWd1cmVkIG9uIGFuIGFscmVhZHkgbG9nZ2VkIGluIHVzZXIuJ1xuICAgICAgICApO1xuICAgIHJldHVybiB7IHNhdmU6IGF3YWl0IHZlcmlmeVJlZ2lzdGVyKGF1dGhEYXRhLCBhZGFwdGVyQ29uZmlnLm9wdGlvbnMsIGNvbmZpZykgfTtcbn07XG5cbmV4cG9ydCBjb25zdCB2YWxpZGF0ZVVwZGF0ZSA9IHZhbGlkYXRlU2V0VXA7XG5cbmV4cG9ydCBjb25zdCB2YWxpZGF0ZUxvZ2luID0gYXN5bmMgKGF1dGhEYXRhLCBhZGFwdGVyQ29uZmlnID0ge30sIHJlcXVlc3QsIGNvbmZpZykgPT4ge1xuICAgIGlmICghcmVxdWVzdC5vcmlnaW5hbClcbiAgICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLk9USEVSX0NBVVNFLCAnVXNlciBub3QgZm91bmQgZm9yIHdlYmF1dGhuIGxvZ2luLicpO1xuICAgIC8vIFdpbGwgc2F2ZSB1cGRhdGVkIGNvdW50ZXIgb2YgdGhlIGNyZWRlbnRpYWxcbiAgICAvLyBhbmQgYXZvaWQgY2xvbmVkL2J1Z2dlZCBhdXRoZW50aWNhdG9yc1xuICAgIHJldHVybiB7IHNhdmU6IHZlcmlmeUxvZ2luKGF1dGhEYXRhLCBhZGFwdGVyQ29uZmlnLm9wdGlvbnMsIGNvbmZpZywgcmVxdWVzdC5vcmlnaW5hbCkgfTtcbn07XG5cbmV4cG9ydCBjb25zdCBwb2xpY3kgPSAnc29sbyc7XG4iXX0=