"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DefinedSchemas = void 0;

var _node = _interopRequireDefault(require("parse/node"));

var _logger = require("./logger");

var _Config = _interopRequireDefault(require("./Config"));

var _SchemasRouter = require("./Routers/SchemasRouter");

var _SchemaController = require("./Controllers/SchemaController");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }

function _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }

class DefinedSchemas {
  constructor(localSchemas, config) {
    this.config = _Config.default.get(config.appId);
    this.localSchemas = localSchemas;
    this.retries = 0;
    this.maxRetries = 3;
  } // Simulate save like the SDK
  // We cannot use SDK since routes are disabled


  async saveSchemaToDB(schema) {
    const payload = {
      className: schema.className,
      fields: schema._fields,
      indexes: schema._indexes,
      classLevelPermissions: schema._clp
    };
    await (0, _SchemasRouter.internalCreateSchema)(schema.className, payload, this.config);
    this.resetSchemaOps(schema);
  }

  async resetSchemaOps(schema) {
    // Reset ops like SDK
    schema._fields = {};
    schema._indexes = {};
  } // Simulate update like the SDK
  // We cannot use SDK since routes are disabled


  async updateSchemaToDB(schema) {
    const payload = {
      className: schema.className,
      fields: schema._fields,
      indexes: schema._indexes,
      classLevelPermissions: schema._clp
    };
    await (0, _SchemasRouter.internalUpdateSchema)(schema.className, payload, this.config);
    this.resetSchemaOps(schema);
  }

  async execute() {
    let timeout;

    try {
      // Set up a time out in production
      // if we fail to get schema
      // pm2 or K8s and many other process managers will try to restart the process
      // after the exit
      timeout = setTimeout(() => {
        if (process.env.NODE_ENV === 'production') process.exit(1);
      }, 20000); // Hack to force session schema to be created

      await this.createDeleteSession();
      this.allCloudSchemas = await _node.default.Schema.all();
      clearTimeout(timeout);
      await Promise.all(this.localSchemas.map(async localSchema => this.saveOrUpdate(localSchema)));
      await this.enforceCLPForNonProvidedClass();
    } catch (e) {
      if (timeout) clearTimeout(timeout);

      if (this.retries < this.maxRetries) {
        this.retries++; // first retry 1sec, 2sec, 3sec total 6sec retry sequence
        // retry will only happen in case of deploying multi parse server instance
        // at the same time
        // modern systems like k8 avoid this by doing rolling updates

        await this.wait(1000 * this.retries);
        await this.execute();
      } else {
        _logger.logger.error(e);

        if (process.env.NODE_ENV === 'production') process.exit(1);
      }
    }
  } // Required for testing purpose


  async wait(time) {
    await new Promise(resolve => setTimeout(resolve, time));
  }

  async enforceCLPForNonProvidedClass() {
    const nonProvidedClasses = this.allCloudSchemas.filter(cloudSchema => !this.localSchemas.some(localSchema => localSchema.className === cloudSchema.className));
    await Promise.all(nonProvidedClasses.map(async schema => {
      const parseSchema = new _node.default.Schema(schema.className);
      this.handleCLP(schema, parseSchema);
      await this.updateSchemaToDB(parseSchema);
    }));
  } // Create a fake session since Parse do not create the _Session until
  // a session is created


  async createDeleteSession() {
    const session = new _node.default.Session();
    await session.save(null, {
      useMasterKey: true
    });
    await session.destroy({
      useMasterKey: true
    });
  }

  async saveOrUpdate(localSchema) {
    const cloudSchema = this.allCloudSchemas.find(sc => sc.className === localSchema.className);

    if (cloudSchema) {
      await this.updateSchema(localSchema, cloudSchema);
    } else {
      await this.saveSchema(localSchema);
    }
  }

  async saveSchema(localSchema) {
    const newLocalSchema = new _node.default.Schema(localSchema.className);

    if (localSchema.fields) {
      // Handle fields
      Object.keys(localSchema.fields).filter(fieldName => !this.isProtectedFields(localSchema.className, fieldName)).forEach(fieldName => {
        const _localSchema$fields$f = localSchema.fields[fieldName],
              {
          type
        } = _localSchema$fields$f,
              others = _objectWithoutProperties(_localSchema$fields$f, ["type"]);

        this.handleFields(newLocalSchema, fieldName, type, others);
      });
    } // Handle indexes


    if (localSchema.indexes) {
      Object.keys(localSchema.indexes).forEach(indexName => {
        if (!this.isProtectedIndex(localSchema.className, indexName)) {
          newLocalSchema.addIndex(indexName, localSchema.indexes[indexName]);
        }
      });
    }

    this.handleCLP(localSchema, newLocalSchema);
    return this.saveSchemaToDB(newLocalSchema);
  }

  async updateSchema(localSchema, cloudSchema) {
    const newLocalSchema = new _node.default.Schema(localSchema.className); // Handle fields
    // Check addition

    if (localSchema.fields) {
      Object.keys(localSchema.fields).filter(fieldName => !this.isProtectedFields(localSchema.className, fieldName)).forEach(fieldName => {
        const _localSchema$fields$f2 = localSchema.fields[fieldName],
              {
          type
        } = _localSchema$fields$f2,
              others = _objectWithoutProperties(_localSchema$fields$f2, ["type"]);

        if (!cloudSchema.fields[fieldName]) this.handleFields(newLocalSchema, fieldName, type, others);
      });
    }

    const fieldsToDelete = [];
    const fieldsToRecreate = [];
    const fieldsWithChangedParams = []; // Check deletion

    Object.keys(cloudSchema.fields).filter(fieldName => !this.isProtectedFields(localSchema.className, fieldName)).forEach(async fieldName => {
      const field = cloudSchema.fields[fieldName];

      if (!localSchema.fields || !localSchema.fields[fieldName]) {
        fieldsToDelete.push(fieldName);
        return;
      }

      const localField = localSchema.fields[fieldName]; // Check if field has a changed type

      if (!this.paramsAreEquals({
        type: field.type,
        targetClass: field.targetClass
      }, {
        type: localField.type,
        targetClass: localField.targetClass
      })) {
        fieldsToRecreate.push(fieldName);
        fieldsToDelete.push(fieldName);
        return;
      } // Check if something changed other than the type (like required, defaultValue)


      if (!this.paramsAreEquals(field, localField)) {
        fieldsWithChangedParams.push(fieldName);
      }
    });
    fieldsToDelete.forEach(fieldName => {
      newLocalSchema.deleteField(fieldName);
    }); // Delete fields from the schema then apply changes

    await this.updateSchemaToDB(newLocalSchema);
    fieldsToRecreate.forEach(fieldName => {
      const _localSchema$fields$f3 = localSchema.fields[fieldName],
            {
        type
      } = _localSchema$fields$f3,
            others = _objectWithoutProperties(_localSchema$fields$f3, ["type"]);

      this.handleFields(newLocalSchema, fieldName, type, others);
    });
    fieldsWithChangedParams.forEach(fieldName => {
      const _localSchema$fields$f4 = localSchema.fields[fieldName],
            {
        type
      } = _localSchema$fields$f4,
            others = _objectWithoutProperties(_localSchema$fields$f4, ["type"]);

      this.handleFields(newLocalSchema, fieldName, type, others);
    }); // Handle Indexes
    // Check addition

    if (localSchema.indexes) {
      Object.keys(localSchema.indexes).forEach(indexName => {
        if ((!cloudSchema.indexes || !cloudSchema.indexes[indexName]) && !this.isProtectedIndex(localSchema.className, indexName)) newLocalSchema.addIndex(indexName, localSchema.indexes[indexName]);
      });
    }

    const indexesToAdd = []; // Check deletion

    if (cloudSchema.indexes) {
      Object.keys(cloudSchema.indexes).forEach(async indexName => {
        if (!this.isProtectedIndex(localSchema.className, indexName)) {
          if (!localSchema.indexes || !localSchema.indexes[indexName]) {
            newLocalSchema.deleteIndex(indexName);
          } else if (!this.paramsAreEquals(localSchema.indexes[indexName], cloudSchema.indexes[indexName])) {
            newLocalSchema.deleteIndex(indexName);
            indexesToAdd.push({
              indexName,
              index: localSchema.indexes[indexName]
            });
          }
        }
      });
    }

    this.handleCLP(localSchema, newLocalSchema, cloudSchema); // Apply changes

    await this.updateSchemaToDB(newLocalSchema); // Apply new/changed indexes

    if (indexesToAdd.length) {
      indexesToAdd.forEach(o => newLocalSchema.addIndex(o.indexName, o.index));
      await this.updateSchemaToDB(newLocalSchema);
    }
  }

  handleCLP(localSchema, newLocalSchema, cloudSchema) {
    if (!localSchema.classLevelPermissions && !cloudSchema) {
      _logger.logger.warn(`classLevelPermissions not provided for ${localSchema.className}.`);
    }

    const clp = localSchema.classLevelPermissions || {};
    const cloudCLP = cloudSchema && cloudSchema.classLevelPermissions || {}; // Try to inject default CLPs

    const CLPKeys = ['find', 'count', 'get', 'create', 'update', 'delete', 'addField'];
    CLPKeys.forEach(key => {
      if (!clp[key]) {
        clp[key] = cloudCLP[key] || {
          '*': true
        };
      }
    }); // To avoid inconsistency we need to remove all rights on addField

    clp.addField = {};
    newLocalSchema.setCLP(clp);
  }

  isProtectedFields(className, fieldName) {
    return !!_SchemaController.defaultColumns._Default[fieldName] || !!(_SchemaController.defaultColumns[className] && _SchemaController.defaultColumns[className][fieldName]);
  }

  isProtectedIndex(className, indexName) {
    let indexes = ['_id_'];

    if (className === '_User') {
      indexes = [...indexes, 'case_insensitive_username', 'case_insensitive_email', 'username_1', 'email_1'];
    }

    return indexes.indexOf(indexName) !== -1;
  }

  paramsAreEquals(indexA, indexB) {
    const keysIndexA = Object.keys(indexA);
    const keysIndexB = Object.keys(indexB); // Check key name

    if (keysIndexA.length !== keysIndexB.length) return false;
    return keysIndexA.every(k => indexA[k] === indexB[k]);
  }

  handleFields(newLocalSchema, fieldName, type, others) {
    if (type === 'Relation') {
      newLocalSchema.addRelation(fieldName, others.targetClass);
    } else if (type === 'Pointer') {
      const {
        targetClass
      } = others,
            others2 = _objectWithoutProperties(others, ["targetClass"]);

      newLocalSchema.addPointer(fieldName, targetClass, others2);
    } else {
      newLocalSchema.addField(fieldName, type, others);
    }
  }

}

exports.DefinedSchemas = DefinedSchemas;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9EZWZpbmVkU2NoZW1hcy5qcyJdLCJuYW1lcyI6WyJEZWZpbmVkU2NoZW1hcyIsImNvbnN0cnVjdG9yIiwibG9jYWxTY2hlbWFzIiwiY29uZmlnIiwiQ29uZmlnIiwiZ2V0IiwiYXBwSWQiLCJyZXRyaWVzIiwibWF4UmV0cmllcyIsInNhdmVTY2hlbWFUb0RCIiwic2NoZW1hIiwicGF5bG9hZCIsImNsYXNzTmFtZSIsImZpZWxkcyIsIl9maWVsZHMiLCJpbmRleGVzIiwiX2luZGV4ZXMiLCJjbGFzc0xldmVsUGVybWlzc2lvbnMiLCJfY2xwIiwicmVzZXRTY2hlbWFPcHMiLCJ1cGRhdGVTY2hlbWFUb0RCIiwiZXhlY3V0ZSIsInRpbWVvdXQiLCJzZXRUaW1lb3V0IiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwiZXhpdCIsImNyZWF0ZURlbGV0ZVNlc3Npb24iLCJhbGxDbG91ZFNjaGVtYXMiLCJQYXJzZSIsIlNjaGVtYSIsImFsbCIsImNsZWFyVGltZW91dCIsIlByb21pc2UiLCJtYXAiLCJsb2NhbFNjaGVtYSIsInNhdmVPclVwZGF0ZSIsImVuZm9yY2VDTFBGb3JOb25Qcm92aWRlZENsYXNzIiwiZSIsIndhaXQiLCJsb2dnZXIiLCJlcnJvciIsInRpbWUiLCJyZXNvbHZlIiwibm9uUHJvdmlkZWRDbGFzc2VzIiwiZmlsdGVyIiwiY2xvdWRTY2hlbWEiLCJzb21lIiwicGFyc2VTY2hlbWEiLCJoYW5kbGVDTFAiLCJzZXNzaW9uIiwiU2Vzc2lvbiIsInNhdmUiLCJ1c2VNYXN0ZXJLZXkiLCJkZXN0cm95IiwiZmluZCIsInNjIiwidXBkYXRlU2NoZW1hIiwic2F2ZVNjaGVtYSIsIm5ld0xvY2FsU2NoZW1hIiwiT2JqZWN0Iiwia2V5cyIsImZpZWxkTmFtZSIsImlzUHJvdGVjdGVkRmllbGRzIiwiZm9yRWFjaCIsInR5cGUiLCJvdGhlcnMiLCJoYW5kbGVGaWVsZHMiLCJpbmRleE5hbWUiLCJpc1Byb3RlY3RlZEluZGV4IiwiYWRkSW5kZXgiLCJmaWVsZHNUb0RlbGV0ZSIsImZpZWxkc1RvUmVjcmVhdGUiLCJmaWVsZHNXaXRoQ2hhbmdlZFBhcmFtcyIsImZpZWxkIiwicHVzaCIsImxvY2FsRmllbGQiLCJwYXJhbXNBcmVFcXVhbHMiLCJ0YXJnZXRDbGFzcyIsImRlbGV0ZUZpZWxkIiwiaW5kZXhlc1RvQWRkIiwiZGVsZXRlSW5kZXgiLCJpbmRleCIsImxlbmd0aCIsIm8iLCJ3YXJuIiwiY2xwIiwiY2xvdWRDTFAiLCJDTFBLZXlzIiwia2V5IiwiYWRkRmllbGQiLCJzZXRDTFAiLCJkZWZhdWx0Q29sdW1ucyIsIl9EZWZhdWx0IiwiaW5kZXhPZiIsImluZGV4QSIsImluZGV4QiIsImtleXNJbmRleEEiLCJrZXlzSW5kZXhCIiwiZXZlcnkiLCJrIiwiYWRkUmVsYXRpb24iLCJvdGhlcnMyIiwiYWRkUG9pbnRlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7OztBQUVPLE1BQU1BLGNBQU4sQ0FBcUI7QUFDMUJDLEVBQUFBLFdBQVcsQ0FBQ0MsWUFBRCxFQUFlQyxNQUFmLEVBQXVCO0FBQ2hDLFNBQUtBLE1BQUwsR0FBY0MsZ0JBQU9DLEdBQVAsQ0FBV0YsTUFBTSxDQUFDRyxLQUFsQixDQUFkO0FBQ0EsU0FBS0osWUFBTCxHQUFvQkEsWUFBcEI7QUFDQSxTQUFLSyxPQUFMLEdBQWUsQ0FBZjtBQUNBLFNBQUtDLFVBQUwsR0FBa0IsQ0FBbEI7QUFDRCxHQU55QixDQVExQjtBQUNBOzs7QUFDQSxRQUFNQyxjQUFOLENBQXFCQyxNQUFyQixFQUE2QjtBQUMzQixVQUFNQyxPQUFPLEdBQUc7QUFDZEMsTUFBQUEsU0FBUyxFQUFFRixNQUFNLENBQUNFLFNBREo7QUFFZEMsTUFBQUEsTUFBTSxFQUFFSCxNQUFNLENBQUNJLE9BRkQ7QUFHZEMsTUFBQUEsT0FBTyxFQUFFTCxNQUFNLENBQUNNLFFBSEY7QUFJZEMsTUFBQUEscUJBQXFCLEVBQUVQLE1BQU0sQ0FBQ1E7QUFKaEIsS0FBaEI7QUFNQSxV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QUFDNEMsVUFBZixDQUEwQnpDLFNBQTFCLEVBQXFDZ0IsV0FBckMsRUFBa0R3QixPQUFsRDtBQUNELEtBSE0sTUFHQTtBQUNMM0MsTUFBQUEsY0FBYyxDQUFDK0IsUUFBZixDQUF3QjVCLFNBQXhCLEVBQW1DRyxJQUFuQyxFQUF5Q0MsTUFBekM7QUFDRDtBQUNGOztBQTNTeUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUGFyc2UgZnJvbSAncGFyc2Uvbm9kZSc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgQ29uZmlnIGZyb20gJy4vQ29uZmlnJztcbmltcG9ydCB7IGludGVybmFsQ3JlYXRlU2NoZW1hLCBpbnRlcm5hbFVwZGF0ZVNjaGVtYSB9IGZyb20gJy4vUm91dGVycy9TY2hlbWFzUm91dGVyJztcbmltcG9ydCB7IGRlZmF1bHRDb2x1bW5zIH0gZnJvbSAnLi9Db250cm9sbGVycy9TY2hlbWFDb250cm9sbGVyJztcblxuZXhwb3J0IGNsYXNzIERlZmluZWRTY2hlbWFzIHtcbiAgY29uc3RydWN0b3IobG9jYWxTY2hlbWFzLCBjb25maWcpIHtcbiAgICB0aGlzLmNvbmZpZyA9IENvbmZpZy5nZXQoY29uZmlnLmFwcElkKTtcbiAgICB0aGlzLmxvY2FsU2NoZW1hcyA9IGxvY2FsU2NoZW1hcztcbiAgICB0aGlzLnJldHJpZXMgPSAwO1xuICAgIHRoaXMubWF4UmV0cmllcyA9IDM7XG4gIH1cblxuICAvLyBTaW11bGF0ZSBzYXZlIGxpa2UgdGhlIFNES1xuICAvLyBXZSBjYW5ub3QgdXNlIFNESyBzaW5jZSByb3V0ZXMgYXJlIGRpc2FibGVkXG4gIGFzeW5jIHNhdmVTY2hlbWFUb0RCKHNjaGVtYSkge1xuICAgIGNvbnN0IHBheWxvYWQgPSB7XG4gICAgICBjbGFzc05hbWU6IHNjaGVtYS5jbGFzc05hbWUsXG4gICAgICBmaWVsZHM6IHNjaGVtYS5fZmllbGRzLFxuICAgICAgaW5kZXhlczogc2NoZW1hLl9pbmRleGVzLFxuICAgICAgY2xhc3NMZXZlbFBlcm1pc3Npb25zOiBzY2hlbWEuX2NscCxcbiAgICB9O1xuICAgIGF3YWl0IGludGVybmFsQ3JlYXRlU2NoZW1hKHNjaGVtYS5jbGFzc05hbWUsIHBheWxvYWQsIHRoaXMuY29uZmlnKTtcbiAgICB0aGlzLnJlc2V0U2NoZW1hT3BzKHNjaGVtYSk7XG4gIH1cblxuICBhc3luYyByZXNldFNjaGVtYU9wcyhzY2hlbWEpIHtcbiAgICAvLyBSZXNldCBvcHMgbGlrZSBTREtcbiAgICBzY2hlbWEuX2ZpZWxkcyA9IHt9O1xuICAgIHNjaGVtYS5faW5kZXhlcyA9IHt9O1xuICB9XG5cbiAgLy8gU2ltdWxhdGUgdXBkYXRlIGxpa2UgdGhlIFNES1xuICAvLyBXZSBjYW5ub3QgdXNlIFNESyBzaW5jZSByb3V0ZXMgYXJlIGRpc2FibGVkXG4gIGFzeW5jIHVwZGF0ZVNjaGVtYVRvREIoc2NoZW1hKSB7XG4gICAgY29uc3QgcGF5bG9hZCA9IHtcbiAgICAgIGNsYXNzTmFtZTogc2NoZW1hLmNsYXNzTmFtZSxcbiAgICAgIGZpZWxkczogc2NoZW1hLl9maWVsZHMsXG4gICAgICBpbmRleGVzOiBzY2hlbWEuX2luZGV4ZXMsXG4gICAgICBjbGFzc0xldmVsUGVybWlzc2lvbnM6IHNjaGVtYS5fY2xwLFxuICAgIH07XG4gICAgYXdhaXQgaW50ZXJuYWxVcGRhdGVTY2hlbWEoc2NoZW1hLmNsYXNzTmFtZSwgcGF5bG9hZCwgdGhpcy5jb25maWcpO1xuICAgIHRoaXMucmVzZXRTY2hlbWFPcHMoc2NoZW1hKTtcbiAgfVxuXG4gIGFzeW5jIGV4ZWN1dGUoKSB7XG4gICAgbGV0IHRpbWVvdXQ7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFNldCB1cCBhIHRpbWUgb3V0IGluIHByb2R1Y3Rpb25cbiAgICAgIC8vIGlmIHdlIGZhaWwgdG8gZ2V0IHNjaGVtYVxuICAgICAgLy8gcG0yIG9yIEs4cyBhbmQgbWFueSBvdGhlciBwcm9jZXNzIG1hbmFnZXJzIHdpbGwgdHJ5IHRvIHJlc3RhcnQgdGhlIHByb2Nlc3NcbiAgICAgIC8vIGFmdGVyIHRoZSBleGl0XG4gICAgICB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nKSBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICB9LCAyMDAwMCk7XG4gICAgICAvLyBIYWNrIHRvIGZvcmNlIHNlc3Npb24gc2NoZW1hIHRvIGJlIGNyZWF0ZWRcbiAgICAgIGF3YWl0IHRoaXMuY3JlYXRlRGVsZXRlU2Vzc2lvbigpO1xuICAgICAgdGhpcy5hbGxDbG91ZFNjaGVtYXMgPSBhd2FpdCBQYXJzZS5TY2hlbWEuYWxsKCk7XG4gICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbCh0aGlzLmxvY2FsU2NoZW1hcy5tYXAoYXN5bmMgbG9jYWxTY2hlbWEgPT4gdGhpcy5zYXZlT3JVcGRhdGUobG9jYWxTY2hlbWEpKSk7XG4gICAgICBhd2FpdCB0aGlzLmVuZm9yY2VDTFBGb3JOb25Qcm92aWRlZENsYXNzKCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHRpbWVvdXQpIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcbiAgICAgIGlmICh0aGlzLnJldHJpZXMgPCB0aGlzLm1heFJldHJpZXMpIHtcbiAgICAgICAgdGhpcy5yZXRyaWVzKys7XG4gICAgICAgIC8vIGZpcnN0IHJldHJ5IDFzZWMsIDJzZWMsIDNzZWMgdG90YWwgNnNlYyByZXRyeSBzZXF1ZW5jZVxuICAgICAgICAvLyByZXRyeSB3aWxsIG9ubHkgaGFwcGVuIGluIGNhc2Ugb2YgZGVwbG95aW5nIG11bHRpIHBhcnNlIHNlcnZlciBpbnN0YW5jZVxuICAgICAgICAvLyBhdCB0aGUgc2FtZSB0aW1lXG4gICAgICAgIC8vIG1vZGVybiBzeXN0ZW1zIGxpa2UgazggYXZvaWQgdGhpcyBieSBkb2luZyByb2xsaW5nIHVwZGF0ZXNcbiAgICAgICAgYXdhaXQgdGhpcy53YWl0KDEwMDAgKiB0aGlzLnJldHJpZXMpO1xuICAgICAgICBhd2FpdCB0aGlzLmV4ZWN1dGUoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicpIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBSZXF1aXJlZCBmb3IgdGVzdGluZyBwdXJwb3NlXG4gIGFzeW5jIHdhaXQodGltZSkge1xuICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCB0aW1lKSk7XG4gIH1cblxuICBhc3luYyBlbmZvcmNlQ0xQRm9yTm9uUHJvdmlkZWRDbGFzcygpIHtcbiAgICBjb25zdCBub25Qcm92aWRlZENsYXNzZXMgPSB0aGlzLmFsbENsb3VkU2NoZW1hcy5maWx0ZXIoXG4gICAgICBjbG91ZFNjaGVtYSA9PlxuICAgICAgICAhdGhpcy5sb2NhbFNjaGVtYXMuc29tZShsb2NhbFNjaGVtYSA9PiBsb2NhbFNjaGVtYS5jbGFzc05hbWUgPT09IGNsb3VkU2NoZW1hLmNsYXNzTmFtZSlcbiAgICApO1xuICAgIGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgbm9uUHJvdmlkZWRDbGFzc2VzLm1hcChhc3luYyBzY2hlbWEgPT4ge1xuICAgICAgICBjb25zdCBwYXJzZVNjaGVtYSA9IG5ldyBQYXJzZS5TY2hlbWEoc2NoZW1hLmNsYXNzTmFtZSk7XG4gICAgICAgIHRoaXMuaGFuZGxlQ0xQKHNjaGVtYSwgcGFyc2VTY2hlbWEpO1xuICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZVNjaGVtYVRvREIocGFyc2VTY2hlbWEpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLy8gQ3JlYXRlIGEgZmFrZSBzZXNzaW9uIHNpbmNlIFBhcnNlIGRvIG5vdCBjcmVhdGUgdGhlIF9TZXNzaW9uIHVudGlsXG4gIC8vIGEgc2Vzc2lvbiBpcyBjcmVhdGVkXG4gIGFzeW5jIGNyZWF0ZURlbGV0ZVNlc3Npb24oKSB7XG4gICAgY29uc3Qgc2Vzc2lvbiA9IG5ldyBQYXJzZS5TZXNzaW9uKCk7XG4gICAgYXdhaXQgc2Vzc2lvbi5zYXZlKG51bGwsIHsgdXNlTWFzdGVyS2V5OiB0cnVlIH0pO1xuICAgIGF3YWl0IHNlc3Npb24uZGVzdHJveSh7IHVzZU1hc3RlcktleTogdHJ1ZSB9KTtcbiAgfVxuXG4gIGFzeW5jIHNhdmVPclVwZGF0ZShsb2NhbFNjaGVtYSkge1xuICAgIGNvbnN0IGNsb3VkU2NoZW1hID0gdGhpcy5hbGxDbG91ZFNjaGVtYXMuZmluZChzYyA9PiBzYy5jbGFzc05hbWUgPT09IGxvY2FsU2NoZW1hLmNsYXNzTmFtZSk7XG4gICAgaWYgKGNsb3VkU2NoZW1hKSB7XG4gICAgICBhd2FpdCB0aGlzLnVwZGF0ZVNjaGVtYShsb2NhbFNjaGVtYSwgY2xvdWRTY2hlbWEpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCB0aGlzLnNhdmVTY2hlbWEobG9jYWxTY2hlbWEpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNhdmVTY2hlbWEobG9jYWxTY2hlbWEpIHtcbiAgICBjb25zdCBuZXdMb2NhbFNjaGVtYSA9IG5ldyBQYXJzZS5TY2hlbWEobG9jYWxTY2hlbWEuY2xhc3NOYW1lKTtcbiAgICBpZiAobG9jYWxTY2hlbWEuZmllbGRzKSB7XG4gICAgICAvLyBIYW5kbGUgZmllbGRzXG4gICAgICBPYmplY3Qua2V5cyhsb2NhbFNjaGVtYS5maWVsZHMpXG4gICAgICAgIC5maWx0ZXIoZmllbGROYW1lID0+ICF0aGlzLmlzUHJvdGVjdGVkRmllbGRzKGxvY2FsU2NoZW1hLmNsYXNzTmFtZSwgZmllbGROYW1lKSlcbiAgICAgICAgLmZvckVhY2goZmllbGROYW1lID0+IHtcbiAgICAgICAgICBjb25zdCB7IHR5cGUsIC4uLm90aGVycyB9ID0gbG9jYWxTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV07XG4gICAgICAgICAgdGhpcy5oYW5kbGVGaWVsZHMobmV3TG9jYWxTY2hlbWEsIGZpZWxkTmFtZSwgdHlwZSwgb3RoZXJzKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIC8vIEhhbmRsZSBpbmRleGVzXG4gICAgaWYgKGxvY2FsU2NoZW1hLmluZGV4ZXMpIHtcbiAgICAgIE9iamVjdC5rZXlzKGxvY2FsU2NoZW1hLmluZGV4ZXMpLmZvckVhY2goaW5kZXhOYW1lID0+IHtcbiAgICAgICAgaWYgKCF0aGlzLmlzUHJvdGVjdGVkSW5kZXgobG9jYWxTY2hlbWEuY2xhc3NOYW1lLCBpbmRleE5hbWUpKSB7XG4gICAgICAgICAgbmV3TG9jYWxTY2hlbWEuYWRkSW5kZXgoaW5kZXhOYW1lLCBsb2NhbFNjaGVtYS5pbmRleGVzW2luZGV4TmFtZV0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLmhhbmRsZUNMUChsb2NhbFNjaGVtYSwgbmV3TG9jYWxTY2hlbWEpO1xuXG4gICAgcmV0dXJuIHRoaXMuc2F2ZVNjaGVtYVRvREIobmV3TG9jYWxTY2hlbWEpO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlU2NoZW1hKGxvY2FsU2NoZW1hLCBjbG91ZFNjaGVtYSkge1xuICAgIGNvbnN0IG5ld0xvY2FsU2NoZW1hID0gbmV3IFBhcnNlLlNjaGVtYShsb2NhbFNjaGVtYS5jbGFzc05hbWUpO1xuXG4gICAgLy8gSGFuZGxlIGZpZWxkc1xuICAgIC8vIENoZWNrIGFkZGl0aW9uXG4gICAgaWYgKGxvY2FsU2NoZW1hLmZpZWxkcykge1xuICAgICAgT2JqZWN0LmtleXMobG9jYWxTY2hlbWEuZmllbGRzKVxuICAgICAgICAuZmlsdGVyKGZpZWxkTmFtZSA9PiAhdGhpcy5pc1Byb3RlY3RlZEZpZWxkcyhsb2NhbFNjaGVtYS5jbGFzc05hbWUsIGZpZWxkTmFtZSkpXG4gICAgICAgIC5mb3JFYWNoKGZpZWxkTmFtZSA9PiB7XG4gICAgICAgICAgY29uc3QgeyB0eXBlLCAuLi5vdGhlcnMgfSA9IGxvY2FsU2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdO1xuICAgICAgICAgIGlmICghY2xvdWRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0pXG4gICAgICAgICAgICB0aGlzLmhhbmRsZUZpZWxkcyhuZXdMb2NhbFNjaGVtYSwgZmllbGROYW1lLCB0eXBlLCBvdGhlcnMpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBmaWVsZHNUb0RlbGV0ZSA9IFtdO1xuICAgIGNvbnN0IGZpZWxkc1RvUmVjcmVhdGUgPSBbXTtcbiAgICBjb25zdCBmaWVsZHNXaXRoQ2hhbmdlZFBhcmFtcyA9IFtdO1xuXG4gICAgLy8gQ2hlY2sgZGVsZXRpb25cbiAgICBPYmplY3Qua2V5cyhjbG91ZFNjaGVtYS5maWVsZHMpXG4gICAgICAuZmlsdGVyKGZpZWxkTmFtZSA9PiAhdGhpcy5pc1Byb3RlY3RlZEZpZWxkcyhsb2NhbFNjaGVtYS5jbGFzc05hbWUsIGZpZWxkTmFtZSkpXG4gICAgICAuZm9yRWFjaChhc3luYyBmaWVsZE5hbWUgPT4ge1xuICAgICAgICBjb25zdCBmaWVsZCA9IGNsb3VkU2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdO1xuICAgICAgICBpZiAoIWxvY2FsU2NoZW1hLmZpZWxkcyB8fCAhbG9jYWxTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV0pIHtcbiAgICAgICAgICBmaWVsZHNUb0RlbGV0ZS5wdXNoKGZpZWxkTmFtZSk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbG9jYWxGaWVsZCA9IGxvY2FsU2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdO1xuICAgICAgICAvLyBDaGVjayBpZiBmaWVsZCBoYXMgYSBjaGFuZ2VkIHR5cGVcbiAgICAgICAgaWYgKFxuICAgICAgICAgICF0aGlzLnBhcmFtc0FyZUVxdWFscyhcbiAgICAgICAgICAgIHsgdHlwZTogZmllbGQudHlwZSwgdGFyZ2V0Q2xhc3M6IGZpZWxkLnRhcmdldENsYXNzIH0sXG4gICAgICAgICAgICB7IHR5cGU6IGxvY2FsRmllbGQudHlwZSwgdGFyZ2V0Q2xhc3M6IGxvY2FsRmllbGQudGFyZ2V0Q2xhc3MgfVxuICAgICAgICAgIClcbiAgICAgICAgKSB7XG4gICAgICAgICAgZmllbGRzVG9SZWNyZWF0ZS5wdXNoKGZpZWxkTmFtZSk7XG4gICAgICAgICAgZmllbGRzVG9EZWxldGUucHVzaChmaWVsZE5hbWUpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIGlmIHNvbWV0aGluZyBjaGFuZ2VkIG90aGVyIHRoYW4gdGhlIHR5cGUgKGxpa2UgcmVxdWlyZWQsIGRlZmF1bHRWYWx1ZSlcbiAgICAgICAgaWYgKCF0aGlzLnBhcmFtc0FyZUVxdWFscyhmaWVsZCwgbG9jYWxGaWVsZCkpIHtcbiAgICAgICAgICBmaWVsZHNXaXRoQ2hhbmdlZFBhcmFtcy5wdXNoKGZpZWxkTmFtZSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgZmllbGRzVG9EZWxldGUuZm9yRWFjaChmaWVsZE5hbWUgPT4ge1xuICAgICAgbmV3TG9jYWxTY2hlbWEuZGVsZXRlRmllbGQoZmllbGROYW1lKTtcbiAgICB9KTtcblxuICAgIC8vIERlbGV0ZSBmaWVsZHMgZnJvbSB0aGUgc2NoZW1hIHRoZW4gYXBwbHkgY2hhbmdlc1xuICAgIGF3YWl0IHRoaXMudXBkYXRlU2NoZW1hVG9EQihuZXdMb2NhbFNjaGVtYSk7XG5cbiAgICBmaWVsZHNUb1JlY3JlYXRlLmZvckVhY2goZmllbGROYW1lID0+IHtcbiAgICAgIGNvbnN0IHsgdHlwZSwgLi4ub3RoZXJzIH0gPSBsb2NhbFNjaGVtYS5maWVsZHNbZmllbGROYW1lXTtcbiAgICAgIHRoaXMuaGFuZGxlRmllbGRzKG5ld0xvY2FsU2NoZW1hLCBmaWVsZE5hbWUsIHR5cGUsIG90aGVycyk7XG4gICAgfSk7XG4gICAgZmllbGRzV2l0aENoYW5nZWRQYXJhbXMuZm9yRWFjaChmaWVsZE5hbWUgPT4ge1xuICAgICAgY29uc3QgeyB0eXBlLCAuLi5vdGhlcnMgfSA9IGxvY2FsU2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdO1xuICAgICAgdGhpcy5oYW5kbGVGaWVsZHMobmV3TG9jYWxTY2hlbWEsIGZpZWxkTmFtZSwgdHlwZSwgb3RoZXJzKTtcbiAgICB9KTtcblxuICAgIC8vIEhhbmRsZSBJbmRleGVzXG4gICAgLy8gQ2hlY2sgYWRkaXRpb25cbiAgICBpZiAobG9jYWxTY2hlbWEuaW5kZXhlcykge1xuICAgICAgT2JqZWN0LmtleXMobG9jYWxTY2hlbWEuaW5kZXhlcykuZm9yRWFjaChpbmRleE5hbWUgPT4ge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgKCFjbG91ZFNjaGVtYS5pbmRleGVzIHx8ICFjbG91ZFNjaGVtYS5pbmRleGVzW2luZGV4TmFtZV0pICYmXG4gICAgICAgICAgIXRoaXMuaXNQcm90ZWN0ZWRJbmRleChsb2NhbFNjaGVtYS5jbGFzc05hbWUsIGluZGV4TmFtZSlcbiAgICAgICAgKVxuICAgICAgICAgIG5ld0xvY2FsU2NoZW1hLmFkZEluZGV4KGluZGV4TmFtZSwgbG9jYWxTY2hlbWEuaW5kZXhlc1tpbmRleE5hbWVdKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGluZGV4ZXNUb0FkZCA9IFtdO1xuXG4gICAgLy8gQ2hlY2sgZGVsZXRpb25cbiAgICBpZiAoY2xvdWRTY2hlbWEuaW5kZXhlcykge1xuICAgICAgT2JqZWN0LmtleXMoY2xvdWRTY2hlbWEuaW5kZXhlcykuZm9yRWFjaChhc3luYyBpbmRleE5hbWUgPT4ge1xuICAgICAgICBpZiAoIXRoaXMuaXNQcm90ZWN0ZWRJbmRleChsb2NhbFNjaGVtYS5jbGFzc05hbWUsIGluZGV4TmFtZSkpIHtcbiAgICAgICAgICBpZiAoIWxvY2FsU2NoZW1hLmluZGV4ZXMgfHwgIWxvY2FsU2NoZW1hLmluZGV4ZXNbaW5kZXhOYW1lXSkge1xuICAgICAgICAgICAgbmV3TG9jYWxTY2hlbWEuZGVsZXRlSW5kZXgoaW5kZXhOYW1lKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKFxuICAgICAgICAgICAgIXRoaXMucGFyYW1zQXJlRXF1YWxzKGxvY2FsU2NoZW1hLmluZGV4ZXNbaW5kZXhOYW1lXSwgY2xvdWRTY2hlbWEuaW5kZXhlc1tpbmRleE5hbWVdKVxuICAgICAgICAgICkge1xuICAgICAgICAgICAgbmV3TG9jYWxTY2hlbWEuZGVsZXRlSW5kZXgoaW5kZXhOYW1lKTtcbiAgICAgICAgICAgIGluZGV4ZXNUb0FkZC5wdXNoKHtcbiAgICAgICAgICAgICAgaW5kZXhOYW1lLFxuICAgICAgICAgICAgICBpbmRleDogbG9jYWxTY2hlbWEuaW5kZXhlc1tpbmRleE5hbWVdLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLmhhbmRsZUNMUChsb2NhbFNjaGVtYSwgbmV3TG9jYWxTY2hlbWEsIGNsb3VkU2NoZW1hKTtcbiAgICAvLyBBcHBseSBjaGFuZ2VzXG4gICAgYXdhaXQgdGhpcy51cGRhdGVTY2hlbWFUb0RCKG5ld0xvY2FsU2NoZW1hKTtcbiAgICAvLyBBcHBseSBuZXcvY2hhbmdlZCBpbmRleGVzXG4gICAgaWYgKGluZGV4ZXNUb0FkZC5sZW5ndGgpIHtcbiAgICAgIGluZGV4ZXNUb0FkZC5mb3JFYWNoKG8gPT4gbmV3TG9jYWxTY2hlbWEuYWRkSW5kZXgoby5pbmRleE5hbWUsIG8uaW5kZXgpKTtcbiAgICAgIGF3YWl0IHRoaXMudXBkYXRlU2NoZW1hVG9EQihuZXdMb2NhbFNjaGVtYSk7XG4gICAgfVxuICB9XG5cbiAgaGFuZGxlQ0xQKGxvY2FsU2NoZW1hLCBuZXdMb2NhbFNjaGVtYSwgY2xvdWRTY2hlbWEpIHtcbiAgICBpZiAoIWxvY2FsU2NoZW1hLmNsYXNzTGV2ZWxQZXJtaXNzaW9ucyAmJiAhY2xvdWRTY2hlbWEpIHtcbiAgICAgIGxvZ2dlci53YXJuKGBjbGFzc0xldmVsUGVybWlzc2lvbnMgbm90IHByb3ZpZGVkIGZvciAke2xvY2FsU2NoZW1hLmNsYXNzTmFtZX0uYCk7XG4gICAgfVxuICAgIGNvbnN0IGNscCA9IGxvY2FsU2NoZW1hLmNsYXNzTGV2ZWxQZXJtaXNzaW9ucyB8fCB7fTtcbiAgICBjb25zdCBjbG91ZENMUCA9IChjbG91ZFNjaGVtYSAmJiBjbG91ZFNjaGVtYS5jbGFzc0xldmVsUGVybWlzc2lvbnMpIHx8IHt9O1xuICAgIC8vIFRyeSB0byBpbmplY3QgZGVmYXVsdCBDTFBzXG4gICAgY29uc3QgQ0xQS2V5cyA9IFsnZmluZCcsICdjb3VudCcsICdnZXQnLCAnY3JlYXRlJywgJ3VwZGF0ZScsICdkZWxldGUnLCAnYWRkRmllbGQnXTtcbiAgICBDTFBLZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIGlmICghY2xwW2tleV0pIHtcbiAgICAgICAgY2xwW2tleV0gPSBjbG91ZENMUFtrZXldIHx8IHsgJyonOiB0cnVlIH07XG4gICAgICB9XG4gICAgfSk7XG4gICAgLy8gVG8gYXZvaWQgaW5jb25zaXN0ZW5jeSB3ZSBuZWVkIHRvIHJlbW92ZSBhbGwgcmlnaHRzIG9uIGFkZEZpZWxkXG4gICAgY2xwLmFkZEZpZWxkID0ge307XG4gICAgbmV3TG9jYWxTY2hlbWEuc2V0Q0xQKGNscCk7XG4gIH1cblxuICBpc1Byb3RlY3RlZEZpZWxkcyhjbGFzc05hbWUsIGZpZWxkTmFtZSkge1xuICAgIHJldHVybiAoXG4gICAgICAhIWRlZmF1bHRDb2x1bW5zLl9EZWZhdWx0W2ZpZWxkTmFtZV0gfHxcbiAgICAgICEhKGRlZmF1bHRDb2x1bW5zW2NsYXNzTmFtZV0gJiYgZGVmYXVsdENvbHVtbnNbY2xhc3NOYW1lXVtmaWVsZE5hbWVdKVxuICAgICk7XG4gIH1cblxuICBpc1Byb3RlY3RlZEluZGV4KGNsYXNzTmFtZSwgaW5kZXhOYW1lKSB7XG4gICAgbGV0IGluZGV4ZXMgPSBbJ19pZF8nXTtcbiAgICBpZiAoY2xhc3NOYW1lID09PSAnX1VzZXInKSB7XG4gICAgICBpbmRleGVzID0gW1xuICAgICAgICAuLi5pbmRleGVzLFxuICAgICAgICAnY2FzZV9pbnNlbnNpdGl2ZV91c2VybmFtZScsXG4gICAgICAgICdjYXNlX2luc2Vuc2l0aXZlX2VtYWlsJyxcbiAgICAgICAgJ3VzZXJuYW1lXzEnLFxuICAgICAgICAnZW1haWxfMScsXG4gICAgICBdO1xuICAgIH1cblxuICAgIHJldHVybiBpbmRleGVzLmluZGV4T2YoaW5kZXhOYW1lKSAhPT0gLTE7XG4gIH1cblxuICBwYXJhbXNBcmVFcXVhbHMoaW5kZXhBLCBpbmRleEIpIHtcbiAgICBjb25zdCBrZXlzSW5kZXhBID0gT2JqZWN0LmtleXMoaW5kZXhBKTtcbiAgICBjb25zdCBrZXlzSW5kZXhCID0gT2JqZWN0LmtleXMoaW5kZXhCKTtcblxuICAgIC8vIENoZWNrIGtleSBuYW1lXG4gICAgaWYgKGtleXNJbmRleEEubGVuZ3RoICE9PSBrZXlzSW5kZXhCLmxlbmd0aCkgcmV0dXJuIGZhbHNlO1xuICAgIHJldHVybiBrZXlzSW5kZXhBLmV2ZXJ5KGsgPT4gaW5kZXhBW2tdID09PSBpbmRleEJba10pO1xuICB9XG5cbiAgaGFuZGxlRmllbGRzKG5ld0xvY2FsU2NoZW1hLCBmaWVsZE5hbWUsIHR5cGUsIG90aGVycykge1xuICAgIGlmICh0eXBlID09PSAnUmVsYXRpb24nKSB7XG4gICAgICBuZXdMb2NhbFNjaGVtYS5hZGRSZWxhdGlvbihmaWVsZE5hbWUsIG90aGVycy50YXJnZXRDbGFzcyk7XG4gICAgfSBlbHNlIGlmICh0eXBlID09PSAnUG9pbnRlcicpIHtcbiAgICAgIGNvbnN0IHsgdGFyZ2V0Q2xhc3MsIC4uLm90aGVyczIgfSA9IG90aGVycztcbiAgICAgIG5ld0xvY2FsU2NoZW1hLmFkZFBvaW50ZXIoZmllbGROYW1lLCB0YXJnZXRDbGFzcywgb3RoZXJzMik7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5ld0xvY2FsU2NoZW1hLmFkZEZpZWxkKGZpZWxkTmFtZSwgdHlwZSwgb3RoZXJzKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==