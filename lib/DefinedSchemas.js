"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DefinedSchemas = void 0;

var _node = _interopRequireDefault(require("parse/node"));

var _logger = require("./logger");

var _Config = _interopRequireDefault(require("./Config"));

var _SchemasRouter = require("./Routers/SchemasRouter");

var _SchemaController = require("./Controllers/SchemaController");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }

function _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }

class DefinedSchemas {
  constructor(localSchemas, config) {
    this.config = _Config.default.get(config.appId);
    this.localSchemas = localSchemas;
    this.retries = 0;
    this.maxRetries = 3;
  } // Simulate save like the SDK
  // We cannot use SDK since routes are disabled


  async saveSchemaToDB(schema) {
    const payload = {
      className: schema.className,
      fields: schema._fields,
      indexes: schema._indexes,
      classLevelPermissions: schema._clp
    };
    await (0, _SchemasRouter.internalCreateSchema)(schema.className, payload, this.config);
    this.resetSchemaOps(schema);
  }

  async resetSchemaOps(schema) {
    // Reset ops like SDK
    schema._fields = {};
    schema._indexes = {};
  } // Simulate update like the SDK
  // We cannot use SDK since routes are disabled


  async updateSchemaToDB(schema) {
    const payload = {
      className: schema.className,
      fields: schema._fields,
      indexes: schema._indexes,
      classLevelPermissions: schema._clp
    };
    await (0, _SchemasRouter.internalUpdateSchema)(schema.className, payload, this.config);
    this.resetSchemaOps(schema);
  }

  async execute() {
    let timeout;

    try {
      // Set up a time out in production
      // if we fail to get schema
      // pm2 or K8s and many other process managers will try to restart the process
      // after the exit
      timeout = setTimeout(() => {
        if (process.env.NODE_ENV === 'production') process.exit(1);
      }, 20000); // Hack to force session schema to be created

      await this.createDeleteSession();
      this.allCloudSchemas = await _node.default.Schema.all();
      clearTimeout(timeout);
      await Promise.all(this.localSchemas.map(async localSchema => this.saveOrUpdate(localSchema)));
      await this.enforceCLPForNonProvidedClass();
    } catch (e) {
      if (timeout) clearTimeout(timeout);

      if (this.retries < this.maxRetries) {
        this.retries++; // first retry 1sec, 2sec, 3sec total 6sec retry sequence
        // retry will only happen in case of deploying multi parse server instance
        // at the same time
        // modern systems like k8 avoid this by doing rolling updates

        await this.wait(1000 * this.retries);
        await this.execute();
      } else {
        _logger.logger.error(e);

        if (process.env.NODE_ENV === 'production') process.exit(1);
      }
    }
  } // Required for testing purpose


  async wait(time) {
    await new Promise(resolve => setTimeout(resolve, time));
  }

  async enforceCLPForNonProvidedClass() {
    const nonProvidedClasses = this.allCloudSchemas.filter(cloudSchema => !this.localSchemas.some(localSchema => localSchema.className === cloudSchema.className));
    await Promise.all(nonProvidedClasses.map(async schema => {
      const parseSchema = new _node.default.Schema(schema.className);
      this.handleCLP(schema, parseSchema);
      await this.updateSchemaToDB(parseSchema);
    }));
  } // Create a fake session since Parse do not create the _Session until
  // a session is created


  async createDeleteSession() {
    const session = new _node.default.Session();
    await session.save(null, {
      useMasterKey: true
    });
    await session.destroy({
      useMasterKey: true
    });
  }

  async saveOrUpdate(localSchema) {
    const cloudSchema = this.allCloudSchemas.find(sc => sc.className === localSchema.className);

    if (cloudSchema) {
      await this.updateSchema(localSchema, cloudSchema);
    } else {
      await this.saveSchema(localSchema);
    }
  }

  async saveSchema(localSchema) {
    const newLocalSchema = new _node.default.Schema(localSchema.className);

    if (localSchema.fields) {
      // Handle fields
      Object.keys(localSchema.fields).filter(fieldName => !this.isProtectedFields(localSchema.className, fieldName)).forEach(fieldName => {
        const _localSchema$fields$f = localSchema.fields[fieldName],
              {
          type
        } = _localSchema$fields$f,
              others = _objectWithoutProperties(_localSchema$fields$f, ["type"]);

        this.handleFields(newLocalSchema, fieldName, type, others);
      });
    } // Handle indexes


    if (localSchema.indexes) {
      Object.keys(localSchema.indexes).forEach(indexName => {
        if (!this.isProtectedIndex(localSchema.className, indexName)) {
          newLocalSchema.addIndex(indexName, localSchema.indexes[indexName]);
        }
      });
    }

    this.handleCLP(localSchema, newLocalSchema);
    return this.saveSchemaToDB(newLocalSchema);
  }

  async updateSchema(localSchema, cloudSchema) {
    const newLocalSchema = new _node.default.Schema(localSchema.className); // Handle fields
    // Check addition

    if (localSchema.fields) {
      Object.keys(localSchema.fields).filter(fieldName => !this.isProtectedFields(localSchema.className, fieldName)).forEach(fieldName => {
        const _localSchema$fields$f2 = localSchema.fields[fieldName],
              {
          type
        } = _localSchema$fields$f2,
              others = _objectWithoutProperties(_localSchema$fields$f2, ["type"]);

        if (!cloudSchema.fields[fieldName]) this.handleFields(newLocalSchema, fieldName, type, others);
      });
    }

    const fieldsToDelete = [];
    const fieldsToRecreate = [];
    const fieldsWithChangedParams = []; // Check deletion

    Object.keys(cloudSchema.fields).filter(fieldName => !this.isProtectedFields(localSchema.className, fieldName)).forEach(async fieldName => {
      const field = cloudSchema.fields[fieldName];

      if (!localSchema.fields || !localSchema.fields[fieldName]) {
        fieldsToDelete.push(fieldName);
        return;
      }

      const localField = localSchema.fields[fieldName]; // Check if field has a changed type

      if (!this.paramsAreEquals({
        type: field.type,
        targetClass: field.targetClass
      }, {
        type: localField.type,
        targetClass: localField.targetClass
      })) {
        fieldsToRecreate.push(fieldName);
        fieldsToDelete.push(fieldName);
        return;
      } // Check if something changed other than the type (like required, defaultValue)


      if (!this.paramsAreEquals(field, localField)) {
        fieldsWithChangedParams.push(fieldName);
      }
    });
    fieldsToDelete.forEach(fieldName => {
      newLocalSchema.deleteField(fieldName);
    }); // Delete fields from the schema then apply changes

    await this.updateSchemaToDB(newLocalSchema);
    fieldsToRecreate.forEach(fieldName => {
      const _localSchema$fields$f3 = localSchema.fields[fieldName],
            {
        type
      } = _localSchema$fields$f3,
            others = _objectWithoutProperties(_localSchema$fields$f3, ["type"]);

      this.handleFields(newLocalSchema, fieldName, type, others);
    });
    fieldsWithChangedParams.forEach(fieldName => {
      const _localSchema$fields$f4 = localSchema.fields[fieldName],
            {
        type
      } = _localSchema$fields$f4,
            others = _objectWithoutProperties(_localSchema$fields$f4, ["type"]);

      this.handleFields(newLocalSchema, fieldName, type, others);
    }); // Handle Indexes
    // Check addition

    if (localSchema.indexes) {
      Object.keys(localSchema.indexes).forEach(indexName => {
        if ((!cloudSchema.indexes || !cloudSchema.indexes[indexName]) && !this.isProtectedIndex(localSchema.className, indexName)) newLocalSchema.addIndex(indexName, localSchema.indexes[indexName]);
      });
    }

    const indexesToAdd = []; // Check deletion

    if (cloudSchema.indexes) {
      Object.keys(cloudSchema.indexes).forEach(async indexName => {
        if (!this.isProtectedIndex(localSchema.className, indexName)) {
          if (!localSchema.indexes || !localSchema.indexes[indexName]) {
            newLocalSchema.deleteIndex(indexName);
          } else if (!this.paramsAreEquals(localSchema.indexes[indexName], cloudSchema.indexes[indexName])) {
            newLocalSchema.deleteIndex(indexName);
            indexesToAdd.push({
              indexName,
              index: localSchema.indexes[indexName]
            });
          }
        }
      });
    }

    this.handleCLP(localSchema, newLocalSchema, cloudSchema); // Apply changes

    await this.updateSchemaToDB(newLocalSchema); // Apply new/changed indexes

    if (indexesToAdd.length) {
      indexesToAdd.forEach(o => newLocalSchema.addIndex(o.indexName, o.index));
      await this.updateSchemaToDB(newLocalSchema);
    }
  }

  handleCLP(localSchema, newLocalSchema, cloudSchema) {
    if (!localSchema.classLevelPermissions && !cloudSchema) {
      _logger.logger.warn(`classLevelPermissions not provided for ${localSchema.className}.`);
    }

    const clp = localSchema.classLevelPermissions || {};
    const cloudCLP = cloudSchema && cloudSchema.classLevelPermissions || {}; // Try to inject default CLPs

    const CLPKeys = ['find', 'count', 'get', 'create', 'update', 'delete', 'addField'];
    CLPKeys.forEach(key => {
      if (!clp[key]) {
        clp[key] = cloudCLP[key] || {
          '*': true
        };
      }
    }); // To avoid inconsistency we need to remove all rights on addField

    clp.addField = {};
    newLocalSchema.setCLP(clp);
  }

  isProtectedFields(className, fieldName) {
    return !!_SchemaController.defaultColumns._Default[fieldName] || !!(_SchemaController.defaultColumns[className] && _SchemaController.defaultColumns[className][fieldName]);
  }

  isProtectedIndex(className, indexName) {
    let indexes = ['_id_'];

    if (className === '_User') {
      indexes = [...indexes, 'case_insensitive_username', 'case_insensitive_email', 'username_1', 'email_1'];
    }

    return indexes.indexOf(indexName) !== -1;
  }

  paramsAreEquals(indexA, indexB) {
    const keysIndexA = Object.keys(indexA);
    const keysIndexB = Object.keys(indexB); // Check key name

    if (keysIndexA.length !== keysIndexB.length) return false;
    return keysIndexA.every(k => indexA[k] === indexB[k]);
  }

  handleFields(newLocalSchema, fieldName, type, others) {
    if (type === 'Relation') {
      newLocalSchema.addRelation(fieldName, others.targetClass);
    } else if (type === 'Pointer') {
      const {
        targetClass
      } = others,
            others2 = _objectWithoutProperties(others, ["targetClass"]);

      newLocalSchema.addPointer(fieldName, targetClass, others2);
    } else {
      newLocalSchema.addField(fieldName, type, others);
    }
  }

}

exports.DefinedSchemas = DefinedSchemas;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9EZWZpbmVkU2NoZW1hcy5qcyJdLCJuYW1lcyI6WyJEZWZpbmVkU2NoZW1hcyIsImNvbnN0cnVjdG9yIiwibG9jYWxTY2hlbWFzIiwiY29uZmlnIiwiQ29uZmlnIiwiZ2V0IiwiYXBwSWQiLCJyZXRyaWVzIiwibWF4UmV0cmllcyIsInNhdmVTY2hlbWFUb0RCIiwic2NoZW1hIiwicGF5bG9hZCIsImNsYXNzTmFtZSIsImZpZWxkcyIsIl9maWVsZHMiLCJpbmRleGVzIiwiX2luZGV4ZXMiLCJjbGFzc0xldmVsUGVybWlzc2lvbnMiLCJfY2xwIiwicmVzZXRTY2hlbWFPcHMiLCJ1cGRhdGVTY2hlbWFUb0RCIiwiZXhlY3V0ZSIsInRpbWVvdXQiLCJzZXRUaW1lb3V0IiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwiZXhpdCIsImNyZWF0ZURlbGV0ZVNlc3Npb24iLCJhbGxDbG91ZFNjaGVtYXMiLCJQYXJzZSIsIlNjaGVtYSIsImFsbCIsImNsZWFyVGltZW91dCIsIlByb21pc2UiLCJtYXAiLCJsb2NhbFNjaGVtYSIsInNhdmVPclVwZGF0ZSIsImVuZm9yY2VDTFBGb3JOb25Qcm92aWRlZENsYXNzIiwiZSIsIndhaXQiLCJsb2dnZXIiLCJlcnJvciIsInRpbWUiLCJyZXNvbHZlIiwibm9uUHJvdmlkZWRDbGFzc2VzIiwiZmlsdGVyIiwiY2xvdWRTY2hlbWEiLCJzb21lIiwicGFyc2VTY2hlbWEiLCJoYW5kbGVDTFAiLCJzZXNzaW9uIiwiU2Vzc2lvbiIsInNhdmUiLCJ1c2VNYXN0ZXJLZXkiLCJkZXN0cm95IiwiZmluZCIsInNjIiwidXBkYXRlU2NoZW1hIiwic2F2ZVNjaGVtYSIsIm5ld0xvY2FsU2NoZW1hIiwiT2JqZWN0Iiwia2V5cyIsImZpZWxkTmFtZSIsImlzUHJvdGVjdGVkRmllbGRzIiwiZm9yRWFjaCIsInR5cGUiLCJvdGhlcnMiLCJoYW5kbGVGaWVsZHMiLCJpbmRleE5hbWUiLCJpc1Byb3RlY3RlZEluZGV4IiwiYWRkSW5kZXgiLCJmaWVsZHNUb0RlbGV0ZSIsImZpZWxkc1RvUmVjcmVhdGUiLCJmaWVsZHNXaXRoQ2hhbmdlZFBhcmFtcyIsImZpZWxkIiwicHVzaCIsImxvY2FsRmllbGQiLCJwYXJhbXNBcmVFcXVhbHMiLCJ0YXJnZXRDbGFzcyIsImRlbGV0ZUZpZWxkIiwiaW5kZXhlc1RvQWRkIiwiZGVsZXRlSW5kZXgiLCJpbmRleCIsImxlbmd0aCIsIm8iLCJ3YXJuIiwiY2xwIiwiY2xvdWRDTFAiLCJDTFBLZXlzIiwia2V5IiwiYWRkRmllbGQiLCJzZXRDTFAiLCJkZWZhdWx0Q29sdW1ucyIsIl9EZWZhdWx0IiwiaW5kZXhPZiIsImluZGV4QSIsImluZGV4QiIsImtleXNJbmRleEEiLCJrZXlzSW5kZXhCIiwiZXZlcnkiLCJrIiwiYWRkUmVsYXRpb24iLCJvdGhlcnMyIiwiYWRkUG9pbnRlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7OztBQUVPLE1BQU1BLGNBQU4sQ0FBcUI7QUFDMUJDLEVBQUFBLFdBQVcsQ0FBQ0MsWUFBRCxFQUFlQyxNQUFmLEVBQXVCO0FBQ2hDLFNBQUtBLE1BQUwsR0FBY0MsZ0JBQU9DLEdBQVAsQ0FBV0YsTUFBTSxDQUFDRyxLQUFsQixDQUFkO0FBQ0EsU0FBS0osWUFBTCxHQUFvQkEsWUFBcEI7QUFDQSxTQUFLSyxPQUFMLEdBQWUsQ0FBZjtBQUNBLFNBQUtDLFVBQUwsR0FBa0IsQ0FBbEI7QUFDRCxHQU55QixDQVExQjtBQUNBOzs7QUFDb0IsUUFBZEMsY0FBYyxDQUFDQyxNQUFELEVBQVM7QUFDM0IsVUFBTUMsT0FBTyxHQUFHO0FBQ2RDLE1BQUFBLFNBQVMsRUFBRUYsTUFBTSxDQUFDRSxTQURKO0FBRWRDLE1BQUFBLE1BQU0sRUFBRUgsTUFBTSxDQUFDSSxPQUZEO0FBR2RDLE1BQUFBLE9BQU8sRUFBRUwsTUFBTSxDQUFDTSxRQUhGO0FBSWRDLE1BQUFBLHFCQUFxQixFQUFFUCxNQUFNLENBQUNRO0FBSmhCLEtBQWhCO0FBTUEsVUFB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LENBQTBCekMsU0FBMUIsRUFBcUNnQixXQUFyQyxFQUFrRHdCLE9BQWxEO0FBQ0QsS0FITSxNQUdBO0FBQ0wzQyxNQUFBQSxjQUFjLENBQUMrQixRQUFmLENBQXdCNUIsU0FBeEIsRUFBbUNHLElBQW5DLEVBQXlDQyxNQUF6QztBQUNEO0FBQ0Y7O0FBM1N5QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQYXJzZSBmcm9tICdwYXJzZS9ub2RlJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBDb25maWcgZnJvbSAnLi9Db25maWcnO1xuaW1wb3J0IHsgaW50ZXJuYWxDcmVhdGVTY2hlbWEsIGludGVybmFsVXBkYXRlU2NoZW1hIH0gZnJvbSAnLi9Sb3V0ZXJzL1NjaGVtYXNSb3V0ZXInO1xuaW1wb3J0IHsgZGVmYXVsdENvbHVtbnMgfSBmcm9tICcuL0NvbnRyb2xsZXJzL1NjaGVtYUNvbnRyb2xsZXInO1xuXG5leHBvcnQgY2xhc3MgRGVmaW5lZFNjaGVtYXMge1xuICBjb25zdHJ1Y3Rvcihsb2NhbFNjaGVtYXMsIGNvbmZpZykge1xuICAgIHRoaXMuY29uZmlnID0gQ29uZmlnLmdldChjb25maWcuYXBwSWQpO1xuICAgIHRoaXMubG9jYWxTY2hlbWFzID0gbG9jYWxTY2hlbWFzO1xuICAgIHRoaXMucmV0cmllcyA9IDA7XG4gICAgdGhpcy5tYXhSZXRyaWVzID0gMztcbiAgfVxuXG4gIC8vIFNpbXVsYXRlIHNhdmUgbGlrZSB0aGUgU0RLXG4gIC8vIFdlIGNhbm5vdCB1c2UgU0RLIHNpbmNlIHJvdXRlcyBhcmUgZGlzYWJsZWRcbiAgYXN5bmMgc2F2ZVNjaGVtYVRvREIoc2NoZW1hKSB7XG4gICAgY29uc3QgcGF5bG9hZCA9IHtcbiAgICAgIGNsYXNzTmFtZTogc2NoZW1hLmNsYXNzTmFtZSxcbiAgICAgIGZpZWxkczogc2NoZW1hLl9maWVsZHMsXG4gICAgICBpbmRleGVzOiBzY2hlbWEuX2luZGV4ZXMsXG4gICAgICBjbGFzc0xldmVsUGVybWlzc2lvbnM6IHNjaGVtYS5fY2xwLFxuICAgIH07XG4gICAgYXdhaXQgaW50ZXJuYWxDcmVhdGVTY2hlbWEoc2NoZW1hLmNsYXNzTmFtZSwgcGF5bG9hZCwgdGhpcy5jb25maWcpO1xuICAgIHRoaXMucmVzZXRTY2hlbWFPcHMoc2NoZW1hKTtcbiAgfVxuXG4gIGFzeW5jIHJlc2V0U2NoZW1hT3BzKHNjaGVtYSkge1xuICAgIC8vIFJlc2V0IG9wcyBsaWtlIFNES1xuICAgIHNjaGVtYS5fZmllbGRzID0ge307XG4gICAgc2NoZW1hLl9pbmRleGVzID0ge307XG4gIH1cblxuICAvLyBTaW11bGF0ZSB1cGRhdGUgbGlrZSB0aGUgU0RLXG4gIC8vIFdlIGNhbm5vdCB1c2UgU0RLIHNpbmNlIHJvdXRlcyBhcmUgZGlzYWJsZWRcbiAgYXN5bmMgdXBkYXRlU2NoZW1hVG9EQihzY2hlbWEpIHtcbiAgICBjb25zdCBwYXlsb2FkID0ge1xuICAgICAgY2xhc3NOYW1lOiBzY2hlbWEuY2xhc3NOYW1lLFxuICAgICAgZmllbGRzOiBzY2hlbWEuX2ZpZWxkcyxcbiAgICAgIGluZGV4ZXM6IHNjaGVtYS5faW5kZXhlcyxcbiAgICAgIGNsYXNzTGV2ZWxQZXJtaXNzaW9uczogc2NoZW1hLl9jbHAsXG4gICAgfTtcbiAgICBhd2FpdCBpbnRlcm5hbFVwZGF0ZVNjaGVtYShzY2hlbWEuY2xhc3NOYW1lLCBwYXlsb2FkLCB0aGlzLmNvbmZpZyk7XG4gICAgdGhpcy5yZXNldFNjaGVtYU9wcyhzY2hlbWEpO1xuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZSgpIHtcbiAgICBsZXQgdGltZW91dDtcbiAgICB0cnkge1xuICAgICAgLy8gU2V0IHVwIGEgdGltZSBvdXQgaW4gcHJvZHVjdGlvblxuICAgICAgLy8gaWYgd2UgZmFpbCB0byBnZXQgc2NoZW1hXG4gICAgICAvLyBwbTIgb3IgSzhzIGFuZCBtYW55IG90aGVyIHByb2Nlc3MgbWFuYWdlcnMgd2lsbCB0cnkgdG8gcmVzdGFydCB0aGUgcHJvY2Vzc1xuICAgICAgLy8gYWZ0ZXIgdGhlIGV4aXRcbiAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicpIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgIH0sIDIwMDAwKTtcbiAgICAgIC8vIEhhY2sgdG8gZm9yY2Ugc2Vzc2lvbiBzY2hlbWEgdG8gYmUgY3JlYXRlZFxuICAgICAgYXdhaXQgdGhpcy5jcmVhdGVEZWxldGVTZXNzaW9uKCk7XG4gICAgICB0aGlzLmFsbENsb3VkU2NoZW1hcyA9IGF3YWl0IFBhcnNlLlNjaGVtYS5hbGwoKTtcbiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKHRoaXMubG9jYWxTY2hlbWFzLm1hcChhc3luYyBsb2NhbFNjaGVtYSA9PiB0aGlzLnNhdmVPclVwZGF0ZShsb2NhbFNjaGVtYSkpKTtcbiAgICAgIGF3YWl0IHRoaXMuZW5mb3JjZUNMUEZvck5vblByb3ZpZGVkQ2xhc3MoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAodGltZW91dCkgY2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuICAgICAgaWYgKHRoaXMucmV0cmllcyA8IHRoaXMubWF4UmV0cmllcykge1xuICAgICAgICB0aGlzLnJldHJpZXMrKztcbiAgICAgICAgLy8gZmlyc3QgcmV0cnkgMXNlYywgMnNlYywgM3NlYyB0b3RhbCA2c2VjIHJldHJ5IHNlcXVlbmNlXG4gICAgICAgIC8vIHJldHJ5IHdpbGwgb25seSBoYXBwZW4gaW4gY2FzZSBvZiBkZXBsb3lpbmcgbXVsdGkgcGFyc2Ugc2VydmVyIGluc3RhbmNlXG4gICAgICAgIC8vIGF0IHRoZSBzYW1lIHRpbWVcbiAgICAgICAgLy8gbW9kZXJuIHN5c3RlbXMgbGlrZSBrOCBhdm9pZCB0aGlzIGJ5IGRvaW5nIHJvbGxpbmcgdXBkYXRlc1xuICAgICAgICBhd2FpdCB0aGlzLndhaXQoMTAwMCAqIHRoaXMucmV0cmllcyk7XG4gICAgICAgIGF3YWl0IHRoaXMuZXhlY3V0ZSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdwcm9kdWN0aW9uJykgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIFJlcXVpcmVkIGZvciB0ZXN0aW5nIHB1cnBvc2VcbiAgYXN5bmMgd2FpdCh0aW1lKSB7XG4gICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIHRpbWUpKTtcbiAgfVxuXG4gIGFzeW5jIGVuZm9yY2VDTFBGb3JOb25Qcm92aWRlZENsYXNzKCkge1xuICAgIGNvbnN0IG5vblByb3ZpZGVkQ2xhc3NlcyA9IHRoaXMuYWxsQ2xvdWRTY2hlbWFzLmZpbHRlcihcbiAgICAgIGNsb3VkU2NoZW1hID0+XG4gICAgICAgICF0aGlzLmxvY2FsU2NoZW1hcy5zb21lKGxvY2FsU2NoZW1hID0+IGxvY2FsU2NoZW1hLmNsYXNzTmFtZSA9PT0gY2xvdWRTY2hlbWEuY2xhc3NOYW1lKVxuICAgICk7XG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICBub25Qcm92aWRlZENsYXNzZXMubWFwKGFzeW5jIHNjaGVtYSA9PiB7XG4gICAgICAgIGNvbnN0IHBhcnNlU2NoZW1hID0gbmV3IFBhcnNlLlNjaGVtYShzY2hlbWEuY2xhc3NOYW1lKTtcbiAgICAgICAgdGhpcy5oYW5kbGVDTFAoc2NoZW1hLCBwYXJzZVNjaGVtYSk7XG4gICAgICAgIGF3YWl0IHRoaXMudXBkYXRlU2NoZW1hVG9EQihwYXJzZVNjaGVtYSk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICAvLyBDcmVhdGUgYSBmYWtlIHNlc3Npb24gc2luY2UgUGFyc2UgZG8gbm90IGNyZWF0ZSB0aGUgX1Nlc3Npb24gdW50aWxcbiAgLy8gYSBzZXNzaW9uIGlzIGNyZWF0ZWRcbiAgYXN5bmMgY3JlYXRlRGVsZXRlU2Vzc2lvbigpIHtcbiAgICBjb25zdCBzZXNzaW9uID0gbmV3IFBhcnNlLlNlc3Npb24oKTtcbiAgICBhd2FpdCBzZXNzaW9uLnNhdmUobnVsbCwgeyB1c2VNYXN0ZXJLZXk6IHRydWUgfSk7XG4gICAgYXdhaXQgc2Vzc2lvbi5kZXN0cm95KHsgdXNlTWFzdGVyS2V5OiB0cnVlIH0pO1xuICB9XG5cbiAgYXN5bmMgc2F2ZU9yVXBkYXRlKGxvY2FsU2NoZW1hKSB7XG4gICAgY29uc3QgY2xvdWRTY2hlbWEgPSB0aGlzLmFsbENsb3VkU2NoZW1hcy5maW5kKHNjID0+IHNjLmNsYXNzTmFtZSA9PT0gbG9jYWxTY2hlbWEuY2xhc3NOYW1lKTtcbiAgICBpZiAoY2xvdWRTY2hlbWEpIHtcbiAgICAgIGF3YWl0IHRoaXMudXBkYXRlU2NoZW1hKGxvY2FsU2NoZW1hLCBjbG91ZFNjaGVtYSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMuc2F2ZVNjaGVtYShsb2NhbFNjaGVtYSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2F2ZVNjaGVtYShsb2NhbFNjaGVtYSkge1xuICAgIGNvbnN0IG5ld0xvY2FsU2NoZW1hID0gbmV3IFBhcnNlLlNjaGVtYShsb2NhbFNjaGVtYS5jbGFzc05hbWUpO1xuICAgIGlmIChsb2NhbFNjaGVtYS5maWVsZHMpIHtcbiAgICAgIC8vIEhhbmRsZSBmaWVsZHNcbiAgICAgIE9iamVjdC5rZXlzKGxvY2FsU2NoZW1hLmZpZWxkcylcbiAgICAgICAgLmZpbHRlcihmaWVsZE5hbWUgPT4gIXRoaXMuaXNQcm90ZWN0ZWRGaWVsZHMobG9jYWxTY2hlbWEuY2xhc3NOYW1lLCBmaWVsZE5hbWUpKVxuICAgICAgICAuZm9yRWFjaChmaWVsZE5hbWUgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgdHlwZSwgLi4ub3RoZXJzIH0gPSBsb2NhbFNjaGVtYS5maWVsZHNbZmllbGROYW1lXTtcbiAgICAgICAgICB0aGlzLmhhbmRsZUZpZWxkcyhuZXdMb2NhbFNjaGVtYSwgZmllbGROYW1lLCB0eXBlLCBvdGhlcnMpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgLy8gSGFuZGxlIGluZGV4ZXNcbiAgICBpZiAobG9jYWxTY2hlbWEuaW5kZXhlcykge1xuICAgICAgT2JqZWN0LmtleXMobG9jYWxTY2hlbWEuaW5kZXhlcykuZm9yRWFjaChpbmRleE5hbWUgPT4ge1xuICAgICAgICBpZiAoIXRoaXMuaXNQcm90ZWN0ZWRJbmRleChsb2NhbFNjaGVtYS5jbGFzc05hbWUsIGluZGV4TmFtZSkpIHtcbiAgICAgICAgICBuZXdMb2NhbFNjaGVtYS5hZGRJbmRleChpbmRleE5hbWUsIGxvY2FsU2NoZW1hLmluZGV4ZXNbaW5kZXhOYW1lXSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHRoaXMuaGFuZGxlQ0xQKGxvY2FsU2NoZW1hLCBuZXdMb2NhbFNjaGVtYSk7XG5cbiAgICByZXR1cm4gdGhpcy5zYXZlU2NoZW1hVG9EQihuZXdMb2NhbFNjaGVtYSk7XG4gIH1cblxuICBhc3luYyB1cGRhdGVTY2hlbWEobG9jYWxTY2hlbWEsIGNsb3VkU2NoZW1hKSB7XG4gICAgY29uc3QgbmV3TG9jYWxTY2hlbWEgPSBuZXcgUGFyc2UuU2NoZW1hKGxvY2FsU2NoZW1hLmNsYXNzTmFtZSk7XG5cbiAgICAvLyBIYW5kbGUgZmllbGRzXG4gICAgLy8gQ2hlY2sgYWRkaXRpb25cbiAgICBpZiAobG9jYWxTY2hlbWEuZmllbGRzKSB7XG4gICAgICBPYmplY3Qua2V5cyhsb2NhbFNjaGVtYS5maWVsZHMpXG4gICAgICAgIC5maWx0ZXIoZmllbGROYW1lID0+ICF0aGlzLmlzUHJvdGVjdGVkRmllbGRzKGxvY2FsU2NoZW1hLmNsYXNzTmFtZSwgZmllbGROYW1lKSlcbiAgICAgICAgLmZvckVhY2goZmllbGROYW1lID0+IHtcbiAgICAgICAgICBjb25zdCB7IHR5cGUsIC4uLm90aGVycyB9ID0gbG9jYWxTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV07XG4gICAgICAgICAgaWYgKCFjbG91ZFNjaGVtYS5maWVsZHNbZmllbGROYW1lXSlcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlRmllbGRzKG5ld0xvY2FsU2NoZW1hLCBmaWVsZE5hbWUsIHR5cGUsIG90aGVycyk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGZpZWxkc1RvRGVsZXRlID0gW107XG4gICAgY29uc3QgZmllbGRzVG9SZWNyZWF0ZSA9IFtdO1xuICAgIGNvbnN0IGZpZWxkc1dpdGhDaGFuZ2VkUGFyYW1zID0gW107XG5cbiAgICAvLyBDaGVjayBkZWxldGlvblxuICAgIE9iamVjdC5rZXlzKGNsb3VkU2NoZW1hLmZpZWxkcylcbiAgICAgIC5maWx0ZXIoZmllbGROYW1lID0+ICF0aGlzLmlzUHJvdGVjdGVkRmllbGRzKGxvY2FsU2NoZW1hLmNsYXNzTmFtZSwgZmllbGROYW1lKSlcbiAgICAgIC5mb3JFYWNoKGFzeW5jIGZpZWxkTmFtZSA9PiB7XG4gICAgICAgIGNvbnN0IGZpZWxkID0gY2xvdWRTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV07XG4gICAgICAgIGlmICghbG9jYWxTY2hlbWEuZmllbGRzIHx8ICFsb2NhbFNjaGVtYS5maWVsZHNbZmllbGROYW1lXSkge1xuICAgICAgICAgIGZpZWxkc1RvRGVsZXRlLnB1c2goZmllbGROYW1lKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBsb2NhbEZpZWxkID0gbG9jYWxTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV07XG4gICAgICAgIC8vIENoZWNrIGlmIGZpZWxkIGhhcyBhIGNoYW5nZWQgdHlwZVxuICAgICAgICBpZiAoXG4gICAgICAgICAgIXRoaXMucGFyYW1zQXJlRXF1YWxzKFxuICAgICAgICAgICAgeyB0eXBlOiBmaWVsZC50eXBlLCB0YXJnZXRDbGFzczogZmllbGQudGFyZ2V0Q2xhc3MgfSxcbiAgICAgICAgICAgIHsgdHlwZTogbG9jYWxGaWVsZC50eXBlLCB0YXJnZXRDbGFzczogbG9jYWxGaWVsZC50YXJnZXRDbGFzcyB9XG4gICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICBmaWVsZHNUb1JlY3JlYXRlLnB1c2goZmllbGROYW1lKTtcbiAgICAgICAgICBmaWVsZHNUb0RlbGV0ZS5wdXNoKGZpZWxkTmFtZSk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2hlY2sgaWYgc29tZXRoaW5nIGNoYW5nZWQgb3RoZXIgdGhhbiB0aGUgdHlwZSAobGlrZSByZXF1aXJlZCwgZGVmYXVsdFZhbHVlKVxuICAgICAgICBpZiAoIXRoaXMucGFyYW1zQXJlRXF1YWxzKGZpZWxkLCBsb2NhbEZpZWxkKSkge1xuICAgICAgICAgIGZpZWxkc1dpdGhDaGFuZ2VkUGFyYW1zLnB1c2goZmllbGROYW1lKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICBmaWVsZHNUb0RlbGV0ZS5mb3JFYWNoKGZpZWxkTmFtZSA9PiB7XG4gICAgICBuZXdMb2NhbFNjaGVtYS5kZWxldGVGaWVsZChmaWVsZE5hbWUpO1xuICAgIH0pO1xuXG4gICAgLy8gRGVsZXRlIGZpZWxkcyBmcm9tIHRoZSBzY2hlbWEgdGhlbiBhcHBseSBjaGFuZ2VzXG4gICAgYXdhaXQgdGhpcy51cGRhdGVTY2hlbWFUb0RCKG5ld0xvY2FsU2NoZW1hKTtcblxuICAgIGZpZWxkc1RvUmVjcmVhdGUuZm9yRWFjaChmaWVsZE5hbWUgPT4ge1xuICAgICAgY29uc3QgeyB0eXBlLCAuLi5vdGhlcnMgfSA9IGxvY2FsU2NoZW1hLmZpZWxkc1tmaWVsZE5hbWVdO1xuICAgICAgdGhpcy5oYW5kbGVGaWVsZHMobmV3TG9jYWxTY2hlbWEsIGZpZWxkTmFtZSwgdHlwZSwgb3RoZXJzKTtcbiAgICB9KTtcbiAgICBmaWVsZHNXaXRoQ2hhbmdlZFBhcmFtcy5mb3JFYWNoKGZpZWxkTmFtZSA9PiB7XG4gICAgICBjb25zdCB7IHR5cGUsIC4uLm90aGVycyB9ID0gbG9jYWxTY2hlbWEuZmllbGRzW2ZpZWxkTmFtZV07XG4gICAgICB0aGlzLmhhbmRsZUZpZWxkcyhuZXdMb2NhbFNjaGVtYSwgZmllbGROYW1lLCB0eXBlLCBvdGhlcnMpO1xuICAgIH0pO1xuXG4gICAgLy8gSGFuZGxlIEluZGV4ZXNcbiAgICAvLyBDaGVjayBhZGRpdGlvblxuICAgIGlmIChsb2NhbFNjaGVtYS5pbmRleGVzKSB7XG4gICAgICBPYmplY3Qua2V5cyhsb2NhbFNjaGVtYS5pbmRleGVzKS5mb3JFYWNoKGluZGV4TmFtZSA9PiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAoIWNsb3VkU2NoZW1hLmluZGV4ZXMgfHwgIWNsb3VkU2NoZW1hLmluZGV4ZXNbaW5kZXhOYW1lXSkgJiZcbiAgICAgICAgICAhdGhpcy5pc1Byb3RlY3RlZEluZGV4KGxvY2FsU2NoZW1hLmNsYXNzTmFtZSwgaW5kZXhOYW1lKVxuICAgICAgICApXG4gICAgICAgICAgbmV3TG9jYWxTY2hlbWEuYWRkSW5kZXgoaW5kZXhOYW1lLCBsb2NhbFNjaGVtYS5pbmRleGVzW2luZGV4TmFtZV0pO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgaW5kZXhlc1RvQWRkID0gW107XG5cbiAgICAvLyBDaGVjayBkZWxldGlvblxuICAgIGlmIChjbG91ZFNjaGVtYS5pbmRleGVzKSB7XG4gICAgICBPYmplY3Qua2V5cyhjbG91ZFNjaGVtYS5pbmRleGVzKS5mb3JFYWNoKGFzeW5jIGluZGV4TmFtZSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5pc1Byb3RlY3RlZEluZGV4KGxvY2FsU2NoZW1hLmNsYXNzTmFtZSwgaW5kZXhOYW1lKSkge1xuICAgICAgICAgIGlmICghbG9jYWxTY2hlbWEuaW5kZXhlcyB8fCAhbG9jYWxTY2hlbWEuaW5kZXhlc1tpbmRleE5hbWVdKSB7XG4gICAgICAgICAgICBuZXdMb2NhbFNjaGVtYS5kZWxldGVJbmRleChpbmRleE5hbWUpO1xuICAgICAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgICAgICAhdGhpcy5wYXJhbXNBcmVFcXVhbHMobG9jYWxTY2hlbWEuaW5kZXhlc1tpbmRleE5hbWVdLCBjbG91ZFNjaGVtYS5pbmRleGVzW2luZGV4TmFtZV0pXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBuZXdMb2NhbFNjaGVtYS5kZWxldGVJbmRleChpbmRleE5hbWUpO1xuICAgICAgICAgICAgaW5kZXhlc1RvQWRkLnB1c2goe1xuICAgICAgICAgICAgICBpbmRleE5hbWUsXG4gICAgICAgICAgICAgIGluZGV4OiBsb2NhbFNjaGVtYS5pbmRleGVzW2luZGV4TmFtZV0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHRoaXMuaGFuZGxlQ0xQKGxvY2FsU2NoZW1hLCBuZXdMb2NhbFNjaGVtYSwgY2xvdWRTY2hlbWEpO1xuICAgIC8vIEFwcGx5IGNoYW5nZXNcbiAgICBhd2FpdCB0aGlzLnVwZGF0ZVNjaGVtYVRvREIobmV3TG9jYWxTY2hlbWEpO1xuICAgIC8vIEFwcGx5IG5ldy9jaGFuZ2VkIGluZGV4ZXNcbiAgICBpZiAoaW5kZXhlc1RvQWRkLmxlbmd0aCkge1xuICAgICAgaW5kZXhlc1RvQWRkLmZvckVhY2gobyA9PiBuZXdMb2NhbFNjaGVtYS5hZGRJbmRleChvLmluZGV4TmFtZSwgby5pbmRleCkpO1xuICAgICAgYXdhaXQgdGhpcy51cGRhdGVTY2hlbWFUb0RCKG5ld0xvY2FsU2NoZW1hKTtcbiAgICB9XG4gIH1cblxuICBoYW5kbGVDTFAobG9jYWxTY2hlbWEsIG5ld0xvY2FsU2NoZW1hLCBjbG91ZFNjaGVtYSkge1xuICAgIGlmICghbG9jYWxTY2hlbWEuY2xhc3NMZXZlbFBlcm1pc3Npb25zICYmICFjbG91ZFNjaGVtYSkge1xuICAgICAgbG9nZ2VyLndhcm4oYGNsYXNzTGV2ZWxQZXJtaXNzaW9ucyBub3QgcHJvdmlkZWQgZm9yICR7bG9jYWxTY2hlbWEuY2xhc3NOYW1lfS5gKTtcbiAgICB9XG4gICAgY29uc3QgY2xwID0gbG9jYWxTY2hlbWEuY2xhc3NMZXZlbFBlcm1pc3Npb25zIHx8IHt9O1xuICAgIGNvbnN0IGNsb3VkQ0xQID0gKGNsb3VkU2NoZW1hICYmIGNsb3VkU2NoZW1hLmNsYXNzTGV2ZWxQZXJtaXNzaW9ucykgfHwge307XG4gICAgLy8gVHJ5IHRvIGluamVjdCBkZWZhdWx0IENMUHNcbiAgICBjb25zdCBDTFBLZXlzID0gWydmaW5kJywgJ2NvdW50JywgJ2dldCcsICdjcmVhdGUnLCAndXBkYXRlJywgJ2RlbGV0ZScsICdhZGRGaWVsZCddO1xuICAgIENMUEtleXMuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgaWYgKCFjbHBba2V5XSkge1xuICAgICAgICBjbHBba2V5XSA9IGNsb3VkQ0xQW2tleV0gfHwgeyAnKic6IHRydWUgfTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICAvLyBUbyBhdm9pZCBpbmNvbnNpc3RlbmN5IHdlIG5lZWQgdG8gcmVtb3ZlIGFsbCByaWdodHMgb24gYWRkRmllbGRcbiAgICBjbHAuYWRkRmllbGQgPSB7fTtcbiAgICBuZXdMb2NhbFNjaGVtYS5zZXRDTFAoY2xwKTtcbiAgfVxuXG4gIGlzUHJvdGVjdGVkRmllbGRzKGNsYXNzTmFtZSwgZmllbGROYW1lKSB7XG4gICAgcmV0dXJuIChcbiAgICAgICEhZGVmYXVsdENvbHVtbnMuX0RlZmF1bHRbZmllbGROYW1lXSB8fFxuICAgICAgISEoZGVmYXVsdENvbHVtbnNbY2xhc3NOYW1lXSAmJiBkZWZhdWx0Q29sdW1uc1tjbGFzc05hbWVdW2ZpZWxkTmFtZV0pXG4gICAgKTtcbiAgfVxuXG4gIGlzUHJvdGVjdGVkSW5kZXgoY2xhc3NOYW1lLCBpbmRleE5hbWUpIHtcbiAgICBsZXQgaW5kZXhlcyA9IFsnX2lkXyddO1xuICAgIGlmIChjbGFzc05hbWUgPT09ICdfVXNlcicpIHtcbiAgICAgIGluZGV4ZXMgPSBbXG4gICAgICAgIC4uLmluZGV4ZXMsXG4gICAgICAgICdjYXNlX2luc2Vuc2l0aXZlX3VzZXJuYW1lJyxcbiAgICAgICAgJ2Nhc2VfaW5zZW5zaXRpdmVfZW1haWwnLFxuICAgICAgICAndXNlcm5hbWVfMScsXG4gICAgICAgICdlbWFpbF8xJyxcbiAgICAgIF07XG4gICAgfVxuXG4gICAgcmV0dXJuIGluZGV4ZXMuaW5kZXhPZihpbmRleE5hbWUpICE9PSAtMTtcbiAgfVxuXG4gIHBhcmFtc0FyZUVxdWFscyhpbmRleEEsIGluZGV4Qikge1xuICAgIGNvbnN0IGtleXNJbmRleEEgPSBPYmplY3Qua2V5cyhpbmRleEEpO1xuICAgIGNvbnN0IGtleXNJbmRleEIgPSBPYmplY3Qua2V5cyhpbmRleEIpO1xuXG4gICAgLy8gQ2hlY2sga2V5IG5hbWVcbiAgICBpZiAoa2V5c0luZGV4QS5sZW5ndGggIT09IGtleXNJbmRleEIubGVuZ3RoKSByZXR1cm4gZmFsc2U7XG4gICAgcmV0dXJuIGtleXNJbmRleEEuZXZlcnkoayA9PiBpbmRleEFba10gPT09IGluZGV4QltrXSk7XG4gIH1cblxuICBoYW5kbGVGaWVsZHMobmV3TG9jYWxTY2hlbWEsIGZpZWxkTmFtZSwgdHlwZSwgb3RoZXJzKSB7XG4gICAgaWYgKHR5cGUgPT09ICdSZWxhdGlvbicpIHtcbiAgICAgIG5ld0xvY2FsU2NoZW1hLmFkZFJlbGF0aW9uKGZpZWxkTmFtZSwgb3RoZXJzLnRhcmdldENsYXNzKTtcbiAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdQb2ludGVyJykge1xuICAgICAgY29uc3QgeyB0YXJnZXRDbGFzcywgLi4ub3RoZXJzMiB9ID0gb3RoZXJzO1xuICAgICAgbmV3TG9jYWxTY2hlbWEuYWRkUG9pbnRlcihmaWVsZE5hbWUsIHRhcmdldENsYXNzLCBvdGhlcnMyKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbmV3TG9jYWxTY2hlbWEuYWRkRmllbGQoZmllbGROYW1lLCB0eXBlLCBvdGhlcnMpO1xuICAgIH1cbiAgfVxufVxuIl19